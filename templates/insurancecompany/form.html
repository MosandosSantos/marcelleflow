{% extends 'base/base.html' %} {% block title %}{{ title }} - EsferaFlow
{%endblock %} 
{% block page_title %}
{{ title }}
{% endblock %} 

{% block content %}

<div class="max-w-6xl mx-auto">
  <!-- Cabeçalho -->
  <div class="mb-6 flex justify-between items-center">
    <div>
      <h2 class="text-3xl font-bold text-gray-800">{{ title }}</h2>
      <p class="text-gray-600 mt-1">
        Preencha o CNPJ para buscar os dados automaticamente
      </p>
    </div>
    <a
      href="{% url 'insurancecompany:list' %}"
      class="px-6 py-3 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600 transition-colors shadow-md"
    >
      <i class="fas fa-arrow-left mr-2"></i>Voltar
    </a>
  </div>

  <!-- Formulário -->
  <form
    method="POST"
    class="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-xl p-8 border border-gray-200"
  >
    {% csrf_token %} {% if form.non_field_errors %}
    <div
      class="bg-red-50 border-l-4 border-red-500 text-red-700 px-4 py-3 rounded mb-6 flex items-center"
    >
      <i class="fas fa-exclamation-circle text-red-500 mr-3 text-xl"></i>
      <div>{{ form.non_field_errors }}</div>
    </div>
    {% endif %}

    <!-- Seção: CNPJ (Primeiro campo com destaque) -->
    <div
      class="mb-8 bg-gradient-to-r from-indigo-50 via-purple-50 to-pink-50 p-8 rounded-2xl border-2 border-indigo-300 shadow-lg"
    >
      <h3 class="text-2xl font-bold text-indigo-700 mb-6 flex items-center">
        <i class="fas fa-id-card text-3xl mr-3 animate-pulse"></i>Consulta de
        CNPJ
      </h3>

      <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
        <!-- CNPJ -->
        <div class="md:col-span-8">
          <label
            for="{{ form.document.id_for_label }}"
            class="block text-sm font-bold text-gray-700 mb-2"
          >
            <i class="fas fa-file-alt text-indigo-600 mr-1"></i> CNPJ
          </label>
          <div class="relative">
            <div
              class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"
            >
              <i class="fas fa-shield-alt text-indigo-500 text-xl"></i>
            </div>
            {{ form.document }}
          </div>
          {% if form.document.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.document.errors.0 }}</p>
          {% endif %}
        </div>

        <!-- Botão Consultar -->
        <div class="md:col-span-4">
          <button
            type="button"
            id="consultarCNPJ"
            class="w-full px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg font-bold hover:from-indigo-700 hover:to-purple-700 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105"
          >
            <i class="fas fa-search mr-2"></i>Consultar CNPJ
          </button>
        </div>
      </div>

      <!-- Mensagem de status -->
      <div id="cnpjStatus" class="mt-4 hidden"></div>
    </div>

    <!-- Seção: Informações Básicas -->
    <div
      class="mb-8 bg-gradient-to-r from-purple-50 to-white p-6 rounded-xl border-l-4 border-primary"
    >
      <h3 class="text-xl font-bold text-primary mb-6 flex items-center">
        <i class="fas fa-shield-alt text-2xl mr-3"></i>Informações Básicas
      </h3>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Razão Social -->
        <div class="md:col-span-2">
          <label
            for="{{ form.name.id_for_label }}"
            class="block text-sm font-bold text-gray-700 mb-2"
          >
            <i class="fas fa-shield-alt text-primary mr-2"></i>Razão Social
            <span class="text-red-500">*</span>
          </label>
          <div class="relative">
            <div
              class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
            >
              <i class="fas fa-shield-alt text-primary text-lg"></i>
            </div>
            {{ form.name }}
          </div>
          {% if form.name.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.name.errors.0 }}</p>
          {% endif %}
        </div>

        <!-- Nome Fantasia -->
        <div class="md:col-span-2">
          <label
            for="{{ form.trade_name.id_for_label }}"
            class="block text-sm font-bold text-gray-800 mb-2"
          >
            <i class="fas fa-store text-blue-500 mr-2"></i>Nome Fantasia
          </label>
          <div class="relative">
            <div
              class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
            >
              <i class="fas fa-tag text-gray-400"></i>
            </div>
            {{ form.trade_name }}
          </div>
          {% if form.trade_name.errors %}
          <p class="mt-1 text-sm text-red-600">
            {{ form.trade_name.errors.0 }}
          </p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Seção: Contato -->
    <div class="mb-8">
      <h3
        class="text-xl font-bold text-gray-800 mb-4 pb-3 border-b-2 border-blue-200 bg-gradient-to-r from-blue-50 to-transparent px-4 py-2 rounded-lg"
      >
        <i class="fas fa-address-book text-blue-600 mr-3"></i>Informações de
        Contato
      </h3>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Nome do contato -->
        <div class="relative">
          <label
            for="{{ form.contact_name.id_for_label }}"
            class="block text-sm font-semibold text-gray-700 mb-2"
          >
            <i class="fas fa-user text-blue-500 mr-1"></i>Nome do contato
          </label>
          <div class="relative">
            <div
              class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
            >
              <i class="fas fa-user text-gray-400"></i>
            </div>
            {{ form.contact_name }}
          </div>
          {% if form.contact_name.errors %}
          <p class="mt-1 text-sm text-red-600">
            {{ form.contact_name.errors.0 }}
          </p>
          {% endif %}
        </div>

        <!-- E-mail -->
        <div class="relative">
          <label
            for="{{ form.contact_email.id_for_label }}"
            class="block text-sm font-semibold text-gray-700 mb-2"
          >
            <i class="fas fa-envelope text-blue-500 mr-1"></i>E-mail de Contato
          </label>
          <div class="relative">
            <div
              class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
            >
              <i class="fas fa-at text-gray-400"></i>
            </div>
            {{ form.contact_email }}
          </div>
          {% if form.contact_email.errors %}
          <p class="mt-1 text-sm text-red-600">
            {{ form.contact_email.errors.0 }}
          </p>
          {% endif %}
        </div>

        <!-- Telefone -->
        <div class="relative">
          <label
            for="{{ form.contact_phone.id_for_label }}"
            class="block text-sm font-semibold text-gray-700 mb-2"
          >
            <i class="fas fa-phone text-green-500 mr-1"></i>Telefone de Contato
          </label>
          <div class="relative">
            <div
              class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
            >
              <i class="fas fa-phone-alt text-gray-400"></i>
            </div>
            {{ form.contact_phone }}
          </div>
          {% if form.contact_phone.errors %}
          <p class="mt-1 text-sm text-red-600">
            {{ form.contact_phone.errors.0 }}
          </p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Seção: Status -->
    <div class="mb-8">
      <h3
        class="text-xl font-bold text-gray-800 mb-4 pb-3 border-b-2 border-purple-200 bg-gradient-to-r from-purple-50 to-transparent px-4 py-2 rounded-lg"
      >
        <i class="fas fa-toggle-on text-purple-600 mr-3"></i>Status
      </h3>

      <div
        class="flex items-center bg-purple-50 p-4 rounded-lg border-2 border-purple-200"
      >
        {{ form.is_active }}
        <label
          for="{{ form.is_active.id_for_label }}"
          class="ml-3 text-sm font-semibold text-gray-800"
        >
          <i class="fas fa-check-circle text-purple-500 mr-2"></i>Seguradora
          ativa
        </label>
      </div>
      {% if form.is_active.errors %}
      <p class="mt-1 text-sm text-red-600">{{ form.is_active.errors.0 }}</p>
      {% endif %}
    </div>

    <!-- Botões de Ação -->
    <div class="flex justify-end gap-4 pt-6 border-t-2 border-gray-200">
      <a
        href="{% url 'insurancecompany:list' %}"
        class="px-8 py-3 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600 transition-all duration-200 shadow-lg hover:shadow-xl"
      >
        <i class="fas fa-times mr-2"></i>Cancelar
      </a>
      <button
        type="submit"
        class="px-8 py-3 bg-gradient-to-r from-primary to-purple-600 text-white rounded-lg font-semibold hover:from-purple-600 hover:to-primary transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105"
      >
        <i class="fas fa-save mr-2"></i>{{ button_text }}
      </button>
    </div>
  </form>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // ========== MÁSCARAS ==========

    // Máscara CNPJ
    const cnpjInput = document.getElementById(
      "{{ form.document.id_for_label }}"
    );
    if (cnpjInput) {
      cnpjInput.addEventListener("input", function (e) {
        let value = e.target.value.replace(/\D/g, "");
        if (value.length <= 14) {
          value = value.replace(/^(\d{2})(\d)/, "$1.$2");
          value = value.replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3");
          value = value.replace(/\.(\d{3})(\d)/, ".$1/$2");
          value = value.replace(/(\d{4})(\d)/, "$1-$2");
        }
        e.target.value = value;
      });
    }

    // Máscara Telefone
    const phoneInput = document.getElementById(
      "{{ form.contact_phone.id_for_label }}"
    );
    if (phoneInput) {
      phoneInput.addEventListener("input", function (e) {
        let value = e.target.value.replace(/\D/g, "");
        if (value.length <= 11) {
          if (value.length <= 10) {
            value = value.replace(/^(\d{2})(\d)/, "($1) $2");
            value = value.replace(/(\d{4})(\d)/, "$1-$2");
          } else {
            value = value.replace(/^(\d{2})(\d)/, "($1) $2");
            value = value.replace(/(\d{5})(\d)/, "$1-$2");
          }
        }
        e.target.value = value;
      });
    }

    // ========== CONSULTA CNPJ ==========

    const consultarBtn = document.getElementById("consultarCNPJ");
    const cnpjStatus = document.getElementById("cnpjStatus");

    // Função para exibir mensagens
    function showStatus(message, type) {
      cnpjStatus.className = "mt-4 p-4 rounded-lg flex items-center";

      if (type === "loading") {
        cnpjStatus.className +=
          " bg-blue-50 border-l-4 border-blue-500 text-blue-700";
        cnpjStatus.innerHTML = `
                <i class="fas fa-spinner fa-spin text-blue-500 mr-3 text-xl"></i>
                <div>${message}</div>
            `;
      } else if (type === "success") {
        cnpjStatus.className +=
          " bg-green-50 border-l-4 border-green-500 text-green-700";
        cnpjStatus.innerHTML = `
                <i class="fas fa-check-circle text-green-500 mr-3 text-xl"></i>
                <div>${message}</div>
            `;
      } else if (type === "error") {
        cnpjStatus.className +=
          " bg-red-50 border-l-4 border-red-500 text-red-700";
        cnpjStatus.innerHTML = `
                <i class="fas fa-exclamation-circle text-red-500 mr-3 text-xl"></i>
                <div>${message}</div>
            `;
      }

      cnpjStatus.classList.remove("hidden");
    }

    // Função para formatar telefone
    function formatPhone(phone) {
      if (!phone) return "";
      const cleaned = phone.replace(/\D/g, "");
      if (cleaned.length === 10) {
        return cleaned.replace(/^(\d{2})(\d{4})(\d{4})/, "($1) $2-$3");
      } else if (cleaned.length === 11) {
        return cleaned.replace(/^(\d{2})(\d{5})(\d{4})/, "($1) $2-$3");
      }
      return phone;
    }

    consultarBtn.addEventListener("click", async function () {
      const cnpjValue = cnpjInput.value.replace(/\D/g, "");

      // Validar CNPJ
      if (cnpjValue.length !== 14) {
        showStatus("Por favor, digite um CNPJ válido com 14 dígitos.", "error");
        return;
      }

      // Desabilitar botão
      consultarBtn.disabled = true;
      consultarBtn.innerHTML =
        '<i class="fas fa-spinner fa-spin mr-2"></i>Consultando...';

      showStatus("Consultando CNPJ na Receita Federal...", "loading");

      try {
        // Consultar BrasilAPI
        const response = await fetch(
          `https://brasilapi.com.br/api/cnpj/v1/${cnpjValue}`
        );

        if (!response.ok) {
          throw new Error("CNPJ não encontrado ou inválido");
        }

        const data = await response.json();

        // Preencher campos
        document.getElementById("{{ form.name.id_for_label }}").value =
          data.razao_social || "";
        document.getElementById("{{ form.trade_name.id_for_label }}").value =
          data.nome_fantasia || data.razao_social || "";

        // Email - pegar o primeiro email se existir
        if (data.email) {
          document.getElementById(
            "{{ form.contact_email.id_for_label }}"
          ).value = data.email;
        }

        // Telefone - pegar o primeiro telefone se existir
        if (data.ddd_telefone_1) {
          const phone = `${data.ddd_telefone_1}`;
          document.getElementById(
            "{{ form.contact_phone.id_for_label }}"
          ).value = formatPhone(phone);
        }

        showStatus(
          `✓ Dados encontrados! Empresa: ${data.razao_social}`,
          "success"
        );

        // Scroll suave para o próximo campo
        setTimeout(() => {
          document
            .getElementById("{{ form.contact_email.id_for_label }}")
            .focus();
        }, 1000);
      } catch (error) {
        showStatus(
          `Erro ao consultar CNPJ: ${error.message}. Verifique o número e tente novamente.`,
          "error"
        );
      } finally {
        // Reabilitar botão
        consultarBtn.disabled = false;
        consultarBtn.innerHTML =
          '<i class="fas fa-search mr-2"></i>Consultar CNPJ';
      }
    });

    // Permitir consulta com Enter no campo CNPJ
    cnpjInput.addEventListener("keypress", function (e) {
      if (e.key === "Enter") {
        e.preventDefault();
        consultarBtn.click();
      }
    });
  });
</script>

{% endblock %}
