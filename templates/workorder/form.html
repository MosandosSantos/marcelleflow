{% extends 'base/base.html' %}
{% block title %}{{ title }} - EsferaWork{% endblock %}
{% block page_title %}{{ title }}{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <div class="mb-8 flex flex-wrap justify-between items-center gap-4">
        <div>
            <h2 class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">{{ title }}</h2>
            <p class="text-gray-500 mt-2">
                <i class="fas fa-info-circle mr-1"></i>
                Preencha os dados da ordem de servico
            </p>
        </div>
        <a href="{% url 'workorder:list' %}" class="group px-6 py-3 bg-white border-2 border-gray-300 text-gray-700 rounded-xl font-semibold hover:bg-gray-50 hover:border-gray-400 transition-all duration-300 shadow-md hover:shadow-lg">
            <i class="fas fa-arrow-left mr-2 group-hover:-translate-x-1 transition-transform duration-300"></i>Voltar
        </a>
    </div>

    <!-- Etapas -->
    <div class="mb-8 bg-white rounded-2xl shadow-lg p-6">
        <div class="flex flex-col md:flex-row items-center justify-center gap-6">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white font-bold shadow-lg">
                    <i class="fas fa-clipboard-check"></i>
                </div>
                <span class="ml-3 font-semibold text-gray-800">Dados da OS</span>
            </div>
            <div class="hidden md:block w-24 h-1 bg-gradient-to-r from-blue-500 to-emerald-500 rounded-full"></div>
            <div class="flex items-center">
                <div class="w-12 h-12 bg-gradient-to-r from-emerald-500 to-teal-600 rounded-full flex items-center justify-center text-white font-bold shadow-lg">
                    <i class="fas fa-user"></i>
                </div>
                <span class="ml-3 font-semibold text-gray-800">Cliente e Endereco</span>
            </div>
            <div class="hidden md:block w-24 h-1 bg-gradient-to-r from-emerald-500 to-amber-500 rounded-full"></div>
            <div class="flex items-center">
                <div class="w-12 h-12 bg-gradient-to-r from-amber-500 to-orange-600 rounded-full flex items-center justify-center text-white font-bold shadow-lg">
                    <i class="fas fa-coins"></i>
                </div>
                <span class="ml-3 font-semibold text-gray-800">Valores</span>
            </div>
        </div>
    </div>

    <form method="POST" class="space-y-6" id="workOrderForm">
        {% csrf_token %}

        {% if form.errors %}
        <div class="bg-gradient-to-r from-red-50 to-red-100 border-l-4 border-red-500 rounded-xl p-5 shadow-md">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-lg font-bold text-red-800">Ops! Verifique os campos abaixo</h3>
                    <ul class="mt-2 text-sm text-red-700 space-y-1">
                        {% for field in form %}
                            {% for error in field.errors %}
                            <li><i class="fas fa-times mr-1"></i>{{ field.label }}: {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                        {% for error in form.non_field_errors %}
                        <li><i class="fas fa-times mr-1"></i>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Card: Identificacao e Servico -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden transform hover:scale-[1.01] transition-transform duration-300">
            <div class="bg-gradient-to-r from-blue-500 via-blue-600 to-indigo-600 px-6 py-4">
                <h3 class="text-xl font-bold text-white flex items-center">
                    <span class="bg-white/20 rounded-lg p-2 mr-3">
                        <i class="fas fa-clipboard-check text-xl"></i>
                    </span>
                    Identificacao e Servico
                </h3>
                <p class="text-blue-100 text-sm mt-1 ml-12">Dados principais da ordem</p>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Numero da O.S. <span class="text-red-500">*</span></label>
                    {{ form.code }}
                    {% if form.code.errors %}<p class="mt-1 text-sm text-red-600">{{ form.code.errors.0 }}</p>{% endif %}
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center justify-between">
                        <span>Tipo de Servico <span class="text-red-500">*</span></span>
                        <a href="{% url 'servicetype:create' %}" class="text-white bg-blue-700/30 hover:bg-blue-700/60 rounded-full px-2 py-1 text-xs" title="Adicionar tipo de servico">
                            <i class="fas fa-plus-circle"></i>
                        </a>
                    </label>
                    {{ form.service_type }}
                    {% if form.service_type.errors %}<p class="mt-1 text-sm text-red-600">{{ form.service_type.errors.0 }}</p>{% endif %}
                </div>
                {% if form.instance.pk and form.status %}
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Status da OS</label>
                    {{ form.status }}
                    {% if form.status.errors %}<p class="mt-1 text-sm text-red-600">{{ form.status.errors.0 }}</p>{% endif %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Card: Cliente e Endereco -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden transform hover:scale-[1.01] transition-transform duration-300">
            <div class="bg-gradient-to-r from-emerald-500 via-teal-500 to-cyan-500 px-6 py-4">
                <h3 class="text-xl font-bold text-white flex items-center">
                    <span class="bg-white/20 rounded-lg p-2 mr-3">
                        <i class="fas fa-user text-xl"></i>
                    </span>
                    Cliente e Endereco
                </h3>
                <p class="text-emerald-100 text-sm mt-1 ml-12">Selecionar cliente e preencher endereco</p>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="md:col-span-2">
                    <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center justify-between">
                        <span>Cliente <span class="text-red-500">*</span></span>
                        <a href="{% url 'clients:create' %}" class="text-white bg-emerald-700/30 hover:bg-emerald-700/60 rounded-full px-2 py-1 text-xs" title="Adicionar cliente">
                            <i class="fas fa-plus-circle"></i>
                        </a>
                    </label>
                    {{ form.client }}
                    {% if form.client.errors %}<p class="mt-1 text-sm text-red-600">{{ form.client.errors.0 }}</p>{% endif %}
                    <div id="clientInfo" class="mt-3 text-xs text-gray-600">
                        <div id="clientInfoName" class="font-semibold text-gray-800"></div>
                        <div id="clientInfoMeta" class="text-gray-500"></div>
                    </div>
                </div>

                <div class="md:col-span-2">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Endereco</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-xs font-semibold text-gray-600 mb-1">CEP</label>
                            {{ form.address_zip }}
                            {% if form.address_zip.errors %}<p class="mt-1 text-sm text-red-600">{{ form.address_zip.errors.0 }}</p>{% endif %}
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs font-semibold text-gray-600 mb-1">Rua</label>
                            {{ form.address_street }}
                            {% if form.address_street.errors %}<p class="mt-1 text-sm text-red-600">{{ form.address_street.errors.0 }}</p>{% endif %}
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">Numero</label>
                            {{ form.address_number }}
                            {% if form.address_number.errors %}<p class="mt-1 text-sm text-red-600">{{ form.address_number.errors.0 }}</p>{% endif %}
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">Complemento</label>
                            {{ form.address_complement }}
                            {% if form.address_complement.errors %}<p class="mt-1 text-sm text-red-600">{{ form.address_complement.errors.0 }}</p>{% endif %}
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">Bairro</label>
                            {{ form.address_neighborhood }}
                            {% if form.address_neighborhood.errors %}<p class="mt-1 text-sm text-red-600">{{ form.address_neighborhood.errors.0 }}</p>{% endif %}
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">Cidade</label>
                            {{ form.address_city }}
                            {% if form.address_city.errors %}<p class="mt-1 text-sm text-red-600">{{ form.address_city.errors.0 }}</p>{% endif %}
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs font-semibold text-gray-600 mb-1">Estado</label>
                            {{ form.address_state }}
                            {% if form.address_state.errors %}<p class="mt-1 text-sm text-red-600">{{ form.address_state.errors.0 }}</p>{% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card: Gestao e Tecnico -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden transform hover:scale-[1.01] transition-transform duration-300">
            <div class="bg-gradient-to-r from-purple-500 via-fuchsia-500 to-pink-500 px-6 py-4">
                <h3 class="text-xl font-bold text-white flex items-center">
                    <span class="bg-white/20 rounded-lg p-2 mr-3">
                        <i class="fas fa-users-cog text-xl"></i>
                    </span>
                    Gestao e Tecnico
                </h3>
                <p class="text-purple-100 text-sm mt-1 ml-12">Responsaveis pela OS</p>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Gestora</label>
                    {{ form.service_operator }}
                    {% if form.service_operator.errors %}<p class="mt-1 text-sm text-red-600">{{ form.service_operator.errors.0 }}</p>{% endif %}
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Seguradora</label>
                    {{ form.insurance_company }}
                    {% if form.insurance_company.errors %}<p class="mt-1 text-sm text-red-600">{{ form.insurance_company.errors.0 }}</p>{% endif %}
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Tecnico</label>
                    {{ form.provider }}
                    {% if form.provider.errors %}<p class="mt-1 text-sm text-red-600">{{ form.provider.errors.0 }}</p>{% endif %}
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Laudo</label>
                    {{ form.technical_report }}
                    {% if form.technical_report.errors %}<p class="mt-1 text-sm text-red-600">{{ form.technical_report.errors.0 }}</p>{% endif %}
                </div>
            </div>
        </div>

        <!-- Card: Descricao e Agendamento -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden transform hover:scale-[1.01] transition-transform duration-300">
            <div class="bg-gradient-to-r from-orange-500 via-amber-500 to-yellow-500 px-6 py-4">
                <h3 class="text-xl font-bold text-white flex items-center">
                    <span class="bg-white/20 rounded-lg p-2 mr-3">
                        <i class="fas fa-calendar-check text-xl"></i>
                    </span>
                    Descricao e Agendamento
                </h3>
                <p class="text-orange-100 text-sm mt-1 ml-12">Detalhes do servico e data</p>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="md:col-span-2">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Descricao do Servico</label>
                    {{ form.description }}
                    {% if form.description.errors %}<p class="mt-1 text-sm text-red-600">{{ form.description.errors.0 }}</p>{% endif %}
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Data de Inicio</label>
                    {{ form.scheduled_date }}
                    {% if form.scheduled_date.errors %}<p class="mt-1 text-sm text-red-600">{{ form.scheduled_date.errors.0 }}</p>{% endif %}
                </div>
                {% if form.closed_on and is_edit %}
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Data de encerramento</label>
                    {{ form.closed_on }}
                    {% if form.closed_on.errors %}<p class="mt-1 text-sm text-red-600">{{ form.closed_on.errors.0 }}</p>{% endif %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Card: Valores -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden transform hover:scale-[1.01] transition-transform duration-300">
            <div class="bg-gradient-to-r from-slate-600 via-slate-700 to-slate-800 px-6 py-4">
                <h3 class="text-xl font-bold text-white flex items-center">
                    <span class="bg-white/20 rounded-lg p-2 mr-3">
                        <i class="fas fa-coins text-xl"></i>
                    </span>
                    Valores
                </h3>
                <p class="text-slate-200 text-sm mt-1 ml-12">Valor final</p>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Valor final (R$)</label>
                        {{ form.labor_cost }}
                        {% if form.labor_cost.errors %}<p class="mt-1 text-sm text-red-600">{{ form.labor_cost.errors.0 }}</p>{% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-xl p-6">
            <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                <p class="text-sm text-gray-500">
                    <i class="fas fa-asterisk text-red-500 mr-1"></i>
                    Campos marcados com <span class="text-red-500 font-bold">*</span> sao obrigatorios
                </p>
                <div class="flex gap-4">
                    <a href="{% url 'workorder:list' %}" class="group px-8 py-4 bg-gray-100 text-gray-700 rounded-xl font-bold hover:bg-gray-200 transition-all duration-300 shadow-md hover:shadow-lg flex items-center">
                        <i class="fas fa-times mr-2 group-hover:rotate-90 transition-transform duration-300"></i>Cancelar
                    </a>
                    <button type="submit" class="group px-8 py-4 bg-gradient-to-r from-blue-500 via-purple-500 to-indigo-600 text-white rounded-xl font-bold hover:from-blue-600 hover:via-purple-600 hover:to-indigo-700 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center">
                        <i class="fas fa-save mr-2 group-hover:scale-110 transition-transform duration-300"></i>{{ button_text }}
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Overlay de salvamento -->
<div id="savingOverlay" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40">
    <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm text-center">
        <div class="mx-auto mb-4 h-14 w-14 rounded-full border-4 border-blue-200 border-t-blue-600 animate-spin"></div>
        <p class="text-lg font-semibold text-gray-800">Salvando...</p>
        <p class="text-sm text-gray-500 mt-1">Aguarde enquanto processamos sua OS.</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const workOrderForm = document.getElementById('workOrderForm');
    const savingOverlay = document.getElementById('savingOverlay');
    if (workOrderForm && savingOverlay) {
        workOrderForm.addEventListener('submit', () => {
            savingOverlay.classList.remove('hidden');
            savingOverlay.classList.add('flex');

            const submitButtons = workOrderForm.querySelectorAll('button[type=\"submit\"]');
            submitButtons.forEach((btn) => {
                btn.disabled = true;
                btn.classList.add('opacity-70', 'cursor-not-allowed');
            });
        });
    }
    const clientSelect = document.getElementById('id_client');
    const clientInfo = document.getElementById('clientInfo');
    const clientInfoName = document.getElementById('clientInfoName');
    const clientInfoMeta = document.getElementById('clientInfoMeta');
    const addressZip = document.getElementById('id_address_zip');
    const addressStreet = document.getElementById('id_address_street');
    const addressNumber = document.getElementById('id_address_number');
    const addressComplement = document.getElementById('id_address_complement');
    const addressNeighborhood = document.getElementById('id_address_neighborhood');
    const addressCity = document.getElementById('id_address_city');
    const addressState = document.getElementById('id_address_state');

    async function fetchClientById(id) {
        if (!id) return null;
        const url = `/api/v1/clients/${id}/`;
        const response = await fetch(url, { credentials: 'same-origin' });
        if (!response.ok) return null;
        return await response.json();
    }

    function fillAddressFromClient(client) {
        if (!client) return;
        if (addressZip) addressZip.value = client.zip_code || '';
        if (addressStreet) addressStreet.value = client.street || '';
        if (addressNumber) addressNumber.value = client.number || '';
        if (addressComplement) addressComplement.value = client.complement || '';
        if (addressNeighborhood) addressNeighborhood.value = client.neighborhood || '';
        if (addressCity) addressCity.value = client.city || '';
        if (addressState) addressState.value = client.state || '';
    }

    function showClientInfo(client) {
        if (!clientInfo || !clientInfoName || !clientInfoMeta) return;
        clientInfoName.textContent = client.full_name || '';
        const parts = [];
        if (client.email) parts.push(client.email);
        if (client.phone) parts.push(client.phone);
        const doc = client.cpf || client.cnpj;
        if (doc) parts.push(doc);
        clientInfoMeta.textContent = parts.join(' | ');
    }

    if (clientSelect) {
        clientSelect.addEventListener('change', () => {
            const id = clientSelect.value;
            if (!id) return;
            fetchClientById(id).then((client) => {
                if (!client) return;
                fillAddressFromClient(client);
                showClientInfo(client);
            });
        });

        if (clientSelect.value) {
            fetchClientById(clientSelect.value).then((client) => {
                if (!client) return;
                fillAddressFromClient(client);
                showClientInfo(client);
            });
        }
    }

});
</script>
{% endblock %}
