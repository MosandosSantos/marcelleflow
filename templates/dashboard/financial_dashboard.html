{% extends 'base/base.html' %}
{% load finance_extras %}

{% block title %}Dashboard Financeiro - EsferaWork{% endblock %}
{% block page_title %}Dashboard Financeiro{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
{% endblock %}

{% block content %}
<div class="space-y-8">
  <!-- KPI Cards Financeiros -->
  <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-4">
    <div class="rounded-2xl bg-white p-6 shadow-lg border-l-4 border-green-500">
      <div class="flex items-start justify-between">
        <div>
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Receitas (Mês)</p>
          <p class="mt-2 text-3xl font-bold text-green-600">R$ {{ total_receitas_mes|brl }}</p>
          <p class="text-xs text-slate-500 mt-1">{{ count_receitas_mes }} transações</p>
        </div>
        <div class="rounded-full bg-green-100 p-3">
          <i class="fas fa-arrow-trend-up text-green-600 text-xl"></i>
        </div>
      </div>
    </div>

    <div class="rounded-2xl bg-white p-6 shadow-lg border-l-4 border-red-500">
      <div class="flex items-start justify-between">
        <div>
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Despesas (Mês)</p>
          <p class="mt-2 text-3xl font-bold text-red-600">R$ {{ total_despesas_mes|brl }}</p>
          <p class="text-xs text-slate-500 mt-1">{{ count_despesas_mes }} transações</p>
        </div>
        <div class="rounded-full bg-red-100 p-3">
          <i class="fas fa-arrow-trend-down text-red-600 text-xl"></i>
        </div>
      </div>
    </div>

    <div class="rounded-2xl bg-white p-6 shadow-lg border-l-4 border-purple-500">
      <div class="flex items-start justify-between">
        <div>
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Saldo (Mês)</p>
          <p class="mt-2 text-3xl font-bold {% if saldo_mes < 0 %}text-red-600{% else %}text-purple-700{% endif %}">
            R$ {{ saldo_mes|brl }}
          </p>
          <p class="text-xs text-slate-500 mt-1">Resultado do período</p>
        </div>
        <div class="rounded-full bg-purple-100 p-3">
          <i class="fas fa-wallet text-purple-700 text-xl"></i>
        </div>
      </div>
    </div>

    <div class="rounded-2xl bg-white p-6 shadow-lg border-l-4 border-orange-500">
      <div class="flex items-start justify-between">
        <div>
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Contas a Pagar</p>
          <p class="mt-2 text-3xl font-bold text-orange-600">R$ {{ contas_a_pagar_total|brl }}</p>
          <p class="text-xs text-slate-500 mt-1">{{ contas_a_pagar_count }} pendentes</p>
        </div>
        <div class="rounded-full bg-orange-100 p-3">
          <i class="fas fa-file-invoice text-orange-600 text-xl"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Links Rápidos -->
  <div class="grid grid-cols-1 gap-6 md:grid-cols-3">
    <a href="{% url 'finance:transaction_list' %}" class="rounded-2xl bg-gradient-to-br from-purple-600 to-purple-800 p-6 shadow-lg hover:shadow-xl transition-all">
      <div class="flex items-center gap-4">
        <div class="rounded-full bg-white/20 p-4">
          <i class="fas fa-list text-white text-2xl"></i>
        </div>
        <div>
          <p class="text-white font-bold text-lg">Todas as Transações</p>
          <p class="text-purple-200 text-sm">Gerenciar receitas e despesas</p>
        </div>
      </div>
    </a>

    <a href="{% url 'finance:dre' %}" class="rounded-2xl bg-gradient-to-br from-blue-600 to-blue-800 p-6 shadow-lg hover:shadow-xl transition-all">
      <div class="flex items-center gap-4">
        <div class="rounded-full bg-white/20 p-4">
          <i class="fas fa-chart-line text-white text-2xl"></i>
        </div>
        <div>
          <p class="text-white font-bold text-lg">DRE Gerencial</p>
          <p class="text-blue-200 text-sm">Demonstração de resultados</p>
        </div>
      </div>
    </a>

    <a href="{% url 'finance:cashflow' %}" class="rounded-2xl bg-gradient-to-br from-green-600 to-green-800 p-6 shadow-lg hover:shadow-xl transition-all">
      <div class="flex items-center gap-4">
        <div class="rounded-full bg-white/20 p-4">
          <i class="fas fa-money-bill-wave text-white text-2xl"></i>
        </div>
        <div>
          <p class="text-white font-bold text-lg">Fluxo de Caixa</p>
          <p class="text-green-200 text-sm">Visão consolidada</p>
        </div>
      </div>
    </a>
  </div>

  <!-- Contas em Atraso -->
  {% if contas_atrasadas %}
  <div class="rounded-2xl bg-white p-6 shadow-lg border border-red-200">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-xl font-bold text-red-700">
        <i class="fas fa-exclamation-triangle mr-2"></i>Contas em Atraso
      </h3>
      <span class="inline-flex items-center gap-2 rounded-full bg-red-100 px-4 py-2 text-sm font-semibold text-red-700">
        {{ contas_atrasadas|length }} conta{{ contas_atrasadas|length|pluralize:",s" }}
      </span>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead class="bg-red-700 text-white">
          <tr>
            <th class="px-6 py-3 text-left">Vencimento</th>
            <th class="px-6 py-3 text-left">Descrição</th>
            <th class="px-6 py-3 text-left">Categoria</th>
            <th class="px-6 py-3 text-right">Valor</th>
            <th class="px-6 py-3 text-center">Ação</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-200">
          {% for conta in contas_atrasadas %}
          <tr class="hover:bg-red-50">
            <td class="px-6 py-4 font-medium text-red-600">{{ conta.data_vencimento|date:"d/m/Y" }}</td>
            <td class="px-6 py-4">{{ conta.descricao }}</td>
            <td class="px-6 py-4 text-slate-600">{{ conta.category.nome }}</td>
            <td class="px-6 py-4 text-right font-semibold text-red-600">R$ {{ conta.valor|brl }}</td>
            <td class="px-6 py-4 text-center">
              <a href="{% url 'finance:transaction_update' conta.pk %}" class="text-blue-600 hover:text-blue-800">
                <i class="fas fa-edit"></i> Editar
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  <!-- Top Clientes por Faturamento -->
  <div class="rounded-2xl bg-white p-6 shadow-lg border border-slate-200">
    <h3 class="text-xl font-bold text-slate-900 mb-4">Top 10 Clientes por Faturamento (Ano)</h3>
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead class="bg-purple-700 text-white">
          <tr>
            <th class="px-6 py-3 text-left">Cliente</th>
            <th class="px-6 py-3 text-center">Ordens</th>
            <th class="px-6 py-3 text-right">Faturamento</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-200">
          {% for client in top_clients %}
          <tr class="hover:bg-slate-50">
            <td class="px-6 py-4 font-medium">{{ client.company_name }}</td>
            <td class="px-6 py-4 text-center">{{ client.orders_count }}</td>
            <td class="px-6 py-4 text-right font-semibold text-green-600">R$ {{ client.total_revenue|brl }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Gráficos -->
  <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
    <!-- Receitas vs Despesas -->
    <div class="rounded-2xl bg-white p-6 shadow-lg border border-slate-200">
      <h3 class="text-xl font-bold text-slate-900 mb-4">Receitas vs Despesas (12 meses)</h3>
      <canvas id="revenueExpenseChart"></canvas>
    </div>

    <!-- Distribuição de Despesas -->
    <div class="rounded-2xl bg-white p-6 shadow-lg border border-slate-200">
      <h3 class="text-xl font-bold text-slate-900 mb-4">Distribuição de Despesas</h3>
      <canvas id="expenseDistributionChart"></canvas>
    </div>
  </div>

</div>

<script>
  // Gráfico de Receitas vs Despesas
  const revenueExpenseCtx = document.getElementById('revenueExpenseChart');
  new Chart(revenueExpenseCtx, {
    type: 'line',
    data: {
      labels: {{ chart_months|safe }},
      datasets: [
        {
          label: 'Receitas',
          data: {{ chart_receitas|safe }},
          borderColor: '#10B981',
          backgroundColor: 'rgba(16, 185, 129, 0.1)',
          tension: 0.4
        },
        {
          label: 'Despesas',
          data: {{ chart_despesas|safe }},
          borderColor: '#EF4444',
          backgroundColor: 'rgba(239, 68, 68, 0.1)',
          tension: 0.4
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'bottom'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return 'R$ ' + value.toLocaleString('pt-BR');
            }
          }
        }
      }
    }
  });

  // Gráfico de Distribuição de Despesas
  const expenseDistributionCtx = document.getElementById('expenseDistributionChart');
  new Chart(expenseDistributionCtx, {
    type: 'doughnut',
    data: {
      labels: {{ expense_categories|safe }},
      datasets: [{
        data: {{ expense_values|safe }},
        backgroundColor: [
          '#8B5CF6',
          '#3B82F6',
          '#10B981',
          '#F59E0B',
          '#EF4444',
          '#6366F1',
          '#EC4899'
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });
</script>
{% endblock %}
