{% extends 'base/base.html' %}
{% load l10n %}

{% block title %}Dashboard Admin - EsferaWork{% endblock %}
{% block page_title %}Dashboard Admin{% endblock %}

{% block extra_head %}
<!-- Chart.js para gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

<!-- Leaflet.js para mapas -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Leaflet MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<!-- Font Awesome para ícones -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

<style>
    /* ========== DESIGN SYSTEM: REGRA 60-30-10 ========== */
    :root {
        /* 60% - Cores dominantes (violeta/azul) */
        --color-primary: #7C3AED;
        --color-primary-dark: #6D28D9;
        --color-primary-light: #A78BFA;

        /* 30% - Cores secundárias */
        --color-secondary: #4F46E5;
        --color-secondary-dark: #4338CA;
        --color-secondary-light: #6366F1;

        /* 10% - Cor de destaque (amarelo) - USO RESTRITO */
        --color-accent: #FCD34D;
        --color-accent-dark: #F59E0B;

        /* Cores neutras (background) */
        --color-bg-main: #F9FAFB;
        --color-bg-card: #FFFFFF;
        --color-border: #E5E7EB;

        /* Tipografia */
        --font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        --text-primary: #1F2937;
        --text-secondary: #6B7280;
        --text-tertiary: #9CA3AF;
    }

    /* Fundo claro do site (60% - cor dominante no background) */
    body {
        background: var(--color-bg-main) !important;
        font-family: var(--font-family);
    }
    .main-content {
        background: var(--color-bg-main) !important;
    }

    /* ========== ANIMAÇÕES SUAVES ========== */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes pulse {
        0%, 100% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.05);
        }
    }

    /* ========== GAUGE CUSTOMIZADO ========== */
    .gauge-container {
        position: relative;
        width: 180px;
        height: 120px;
        margin: 0 auto;
    }

    .gauge-glow {
        position: absolute;
        inset: 10px 18px auto 18px;
        height: 100px;
        border-radius: 100px 100px 0 0;
        background: radial-gradient(ellipse at center, rgba(124, 58, 237, 0.18), rgba(124, 58, 237, 0) 70%);
        pointer-events: none;
        z-index: 0;
    }

    .gauge-value {
        position: absolute;
        top: 60%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--color-primary);
        z-index: 2;
        text-shadow: 0 2px 8px rgba(124, 58, 237, 0.3);
    }

    /* ========== SPEEDOMETRO DE SATISFACAO ========== */
    .satisfaction-speedo {
        position: relative;
        height: 210px;
        margin-top: 6px;
    }
    .speedo-svg {
        width: 100%;
        height: 100%;
        overflow: visible;
    }
    .speedo-track {
        fill: none;
        stroke: #E5E7EB;
        stroke-width: 12;
        stroke-linecap: round;
    }
    .speedo-value {
        fill: none;
        stroke: url(#speedoGradient);
        stroke-width: 12;
        stroke-linecap: round;
        stroke-dasharray: 0 100;
        filter: drop-shadow(0 4px 10px rgba(16, 185, 129, 0.35));
    }
    .speedo-ticks line {
        stroke: #CBD5F5;
        stroke-width: 2;
        opacity: 0.85;
    }
    .speedo-needle {
        transform-origin: 100px 100px;
        transition: transform 0.8s ease;
    }
    .speedo-needle line {
        stroke: #111827;
        stroke-width: 3;
        stroke-linecap: round;
        filter: drop-shadow(0 2px 6px rgba(17, 24, 39, 0.35));
    }
    .speedo-needle circle {
        fill: #111827;
        stroke: #F9FAFB;
        stroke-width: 3;
    }
    .speedo-center {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end;
        padding-bottom: 10px;
        gap: 2px;
        text-align: center;
    }
    .speedo-value-text {
        font-size: 1.7rem;
        font-weight: 700;
        color: #111827;
    }
    .speedo-subtext {
        font-size: 0.85rem;
        color: #6B7280;
        letter-spacing: 0.04em;
    }
    .speedo-labels {
        position: absolute;
        bottom: 8px;
        left: 0;
        right: 0;
        display: flex;
        justify-content: space-between;
        font-size: 0.7rem;
        color: #9CA3AF;
        padding: 0 8px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
    }

    /* ========== ESTILO LEAFLET MAPS ========== */
    .leaflet-container {
        border-radius: 0.75rem;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
    }

    /* ========== KPI CARDS: HIERARQUIA VISUAL ========== */
    .kpi-card {
        background: var(--color-bg-card);
        border: 1px solid var(--color-border);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--accent-color), var(--accent-color-light));
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .kpi-card:hover::before {
        opacity: 1;
    }

    .kpi-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 28px rgba(124, 58, 237, 0.15);
    }

    /* Acentos dos KPI cards (60-30-10: tons de violeta/azul) */
    .kpi-accent-1 {
        --accent-color: #7C3AED;
        --accent-color-light: #A78BFA;
        border-top: 4px solid var(--color-primary);
    }

    .kpi-accent-2 {
        --accent-color: #6D28D9;
        --accent-color-light: #9333EA;
        border-top: 4px solid var(--color-primary-dark);
    }

    .kpi-accent-3 {
        --accent-color: #4F46E5;
        --accent-color-light: #6366F1;
        border-top: 4px solid var(--color-secondary);
    }

    .kpi-accent-4 {
        --accent-color: #2563EB;
        --accent-color-light: #3B82F6;
        border-top: 4px solid var(--color-secondary-dark);
    }

    /* Valores dos KPIs (tipografia: grande e bold) */
    .kpi-value-1 { color: var(--color-primary-dark); }
    .kpi-value-2 { color: #5B21B6; }
    .kpi-value-3 { color: var(--color-secondary-dark); }
    .kpi-value-4 { color: #1D4ED8; }

    /* ========== CHART CONTAINERS ========== */
    .chart-container {
        position: relative;
        height: 352px;
        width: 100%;
    }

    /* ========== BADGES MODERNOS ========== */
    .badge-modern {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.375rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .badge-modern:hover {
        transform: scale(1.05);
    }

    /* Status badges (10% - amarelo usado apenas para alertas) */
    .status-badge-pending {
        background: linear-gradient(135deg, #FEF3C7, #FDE68A);
        color: #92400E;
        border: 1px solid var(--color-accent);
    }

    .status-badge-progress {
        background: linear-gradient(135deg, #DBEAFE, #BFDBFE);
        color: #1E40AF;
        border: 1px solid #93C5FD;
    }

    .status-badge-completed {
        background: linear-gradient(135deg, #D1FAE5, #A7F3D0);
        color: #065F46;
        border: 1px solid #6EE7B7;
    }

    .status-badge-cancelled {
        background: linear-gradient(135deg, #FEE2E2, #FECACA);
        color: #991B1B;
        border: 1px solid #FCA5A5;
    }

    /* ========== TABELA CUSTOMIZADA ========== */
    .table-header-modern {
        background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
        color: white;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-size: 0.75rem;
    }

    .table-row-modern {
        transition: all 0.2s ease;
    }

    .table-row-modern:hover {
        background: #F5F3FF;
        transform: translateX(2px);
    }

    /* ========== CARDS FINANCEIROS COM GRADIENTES VIBRANTES ========== */
    .financial-card {
        position: relative;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .financial-card::after {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .financial-card:hover::after {
        opacity: 1;
    }

    .financial-card:hover {
        transform: translateY(-6px) scale(1.02);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }

    /* cones com animação */
    .icon-animated {
        transition: all 0.3s ease;
        display: inline-block;
    }

    .financial-card:hover .icon-animated {
        transform: rotate(15deg) scale(1.2);
    }

    /* ========== SEÇÕES COM ANIMAÇÃO ========== */
    .section-card {
        animation: fadeIn 0.6s ease-out;
        transition: all 0.3s ease;
    }

    .section-card:hover {
        box-shadow: 0 12px 28px rgba(124, 58, 237, 0.12);
    }

    /* ========== TOOLTIPS PERSONALIZADOS ========== */
    .tooltip-custom {
        position: relative;
        cursor: help;
    }

    .tooltip-custom:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        padding: 0.5rem 0.75rem;
        background: #1F2937;
        color: white;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        white-space: nowrap;
        z-index: 1000;
        margin-bottom: 0.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* ========== BADGE DE CONE ========== */
    .icon-badge {
        width: 2rem;
        height: 2rem;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .icon-badge i {
        font-size: 0.875rem;
    }

    .icon-badge-sm {
        width: 1.75rem;
        height: 1.75rem;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Container para gráficos com altura fixa */
    .chart-container {
        height: 220px;
        position: relative;
    }

    .chart-container-sm {
        height: 198px;
        position: relative;
    }

    /* ========== RESPONSIVIDADE ========== */
    @media (max-width: 640px) {
        .gauge-container {
            width: 180px;
            height: 120px;
        }

        .gauge-value {
            font-size: 1.75rem;
        }
    }

    /* ========== SEÇÕES DE TTULO CONSISTENTES ========== */
    .section-title {
        font-size: 1rem;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .section-subtitle {
        font-size: 0.625rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-secondary);
        background: #F3F4F6;
        padding: 0.25rem 0.5rem;
        border-radius: 9999px;
    }

    /* ========== TABELA MODERNA ========== */
    .table-header-modern {
        background: linear-gradient(135deg, #7C3AED, #6D28D9);
        color: white;
        font-weight: 600;
    }

    .table-row-modern:hover {
        background: #F9FAFB;
        transition: background 0.2s ease;
    }
</style>
{% endblock %}

{% block content %}
<!-- Remove o padding padrão do main -->
<div class="-m-6 p-6 bg-gray-50 min-h-screen">

    <!-- ========== 4 KPI CARDS NO TOPO (TIPOGRAFIA MELHORADA) ========== -->
    <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4 mb-4">

        <!-- Card 1: Pedidos Anuais -->
        <div class="kpi-card kpi-accent-1 rounded-xl shadow-md p-3 group">
            <div class="flex items-start justify-between mb-1.5">
                <div class="text-gray-600 text-[10px] uppercase tracking-wider font-bold">Pedidos {{ current_year }}</div>
                <div class="w-7 h-7 rounded-lg bg-purple-100 flex items-center justify-center group-hover:bg-purple-200 transition-colors duration-300 tooltip-custom" data-tooltip="OS criadas no ano atual">
                    <i class="fas fa-chart-line text-purple-600 text-xs"></i>
                </div>
            </div>
            <div class="text-2xl font-bold kpi-value-1 mb-1.5">{{ orders_current_year }}</div>

            <div class="grid grid-cols-3 gap-1.5 text-xs">
                <div class="rounded-md bg-indigo-50 p-1.5 text-center border border-indigo-100 hover:bg-indigo-100 transition-colors duration-200">
                    <div class="font-bold text-indigo-600 text-[10px]">{{ orders_avg_years|floatformat:0 }}</div>
                    <div class="text-gray-600 text-[9px] mt-0.5">Média Anual</div>
                </div>
                <div class="rounded-md bg-blue-50 p-1.5 text-center border border-blue-100 hover:bg-blue-100 transition-colors duration-200">
                    <div class="font-bold text-blue-600 text-[10px]">{{ orders_previous_year }}</div>
                    <div class="text-gray-600 text-[9px] mt-0.5">{{ previous_year }}</div>
                </div>
                <div class="rounded-md {% if orders_growth_percent >= 0 %}bg-emerald-50 border-emerald-100{% else %}bg-rose-50 border-rose-100{% endif %} p-1.5 text-center border hover:{% if orders_growth_percent >= 0 %}bg-emerald-100{% else %}bg-rose-100{% endif %} transition-colors duration-200">
                    <div class="font-bold {% if orders_growth_percent >= 0 %}text-emerald-600{% else %}text-rose-600{% endif %} text-[10px]">
                        {% if orders_growth_percent is not None %}{{ orders_growth_percent }}%{% else %}—{% endif %}
                    </div>
                    <div class="text-gray-600 text-[9px] mt-0.5">YoY</div>
                </div>
            </div>
        </div>

        <!-- Card 2: Pedidos Mensais -->
        <div class="kpi-card kpi-accent-2 rounded-xl shadow-md p-3 group">
            <div class="flex items-start justify-between mb-1.5">
                <div class="text-gray-600 text-[10px] uppercase tracking-wider font-bold">Pedidos {{ current_month_label }}</div>
                <div class="w-7 h-7 rounded-lg bg-purple-100 flex items-center justify-center group-hover:bg-purple-200 transition-colors duration-300 tooltip-custom" data-tooltip="OS criadas no mês atual">
                    <i class="fas fa-dollar-sign text-purple-600 text-xs"></i>
                </div>
            </div>
            <div class="text-2xl font-bold kpi-value-2 mb-1.5">{{ orders_current_month }}</div>

            <div class="grid grid-cols-3 gap-1.5 text-xs">
                <div class="rounded-md bg-indigo-50 p-1.5 text-center border border-indigo-100 hover:bg-indigo-100 transition-colors duration-200">
                    <div class="font-bold text-indigo-600 text-[10px]">{{ orders_avg_months|floatformat:0 }}</div>
                    <div class="text-gray-600 text-[9px] mt-0.5">Média Mensal</div>
                </div>
                <div class="rounded-md bg-blue-50 p-1.5 text-center border border-blue-100 hover:bg-blue-100 transition-colors duration-200">
                    <div class="font-bold text-blue-600 text-[10px]">{{ orders_previous_month }}</div>
                    <div class="text-gray-600 text-[9px] mt-0.5">{{ previous_month_label }}</div>
                </div>
                <div class="rounded-md {% if orders_month_growth_percent >= 0 %}bg-emerald-50 border-emerald-100{% else %}bg-rose-50 border-rose-100{% endif %} p-1.5 text-center border hover:{% if orders_month_growth_percent >= 0 %}bg-emerald-100{% else %}bg-rose-100{% endif %} transition-colors duration-200">
                    <div class="font-bold {% if orders_month_growth_percent >= 0 %}text-emerald-600{% else %}text-rose-600{% endif %} text-[10px]">
                        {% if orders_month_growth_percent is not None %}{{ orders_month_growth_percent }}%{% else %}—{% endif %}
                    </div>
                    <div class="text-gray-600 text-[9px] mt-0.5">MoM</div>
                </div>
            </div>
        </div>

        <!-- Card 3: Pipeline Operacional -->
        <div class="kpi-card kpi-accent-3 rounded-xl shadow-md p-3 group">
            <div class="flex items-start justify-between mb-1.5">
                <div class="text-gray-600 text-[10px] uppercase tracking-wider font-bold">Pipeline Operacional</div>
                <div class="w-7 h-7 rounded-lg bg-indigo-100 flex items-center justify-center group-hover:bg-indigo-200 transition-colors duration-300 tooltip-custom" data-tooltip="OS abertas + em andamento">
                    <i class="fas fa-stream text-indigo-600 text-xs"></i>
                </div>
            </div>
            <div class="text-2xl font-bold kpi-value-3 mb-1.5">{{ open_pipeline_total }}</div>

            <div class="grid grid-cols-3 gap-1.5 text-xs">
                <div class="rounded-md bg-indigo-50 p-1.5 text-center border border-indigo-100 hover:bg-indigo-100 transition-colors duration-200">
                    <div class="font-bold text-indigo-600 text-sm">{{ pending_count }}</div>
                    <div class="text-gray-600 text-[10px] mt-0.5">Abertas</div>
                </div>
                <div class="rounded-md bg-blue-50 p-1.5 text-center border border-blue-100 hover:bg-blue-100 transition-colors duration-200">
                    <div class="font-bold text-blue-600 text-sm">{{ in_progress_count }}</div>
                    <div class="text-gray-600 text-[10px] mt-0.5">Andamento</div>
                </div>
                <div class="rounded-md bg-emerald-50 p-1.5 text-center border border-emerald-100 hover:bg-emerald-100 transition-colors duration-200">
                    <div class="font-bold text-emerald-600 text-sm">{{ waiting_approval_count }}</div>
                    <div class="text-gray-600 text-[10px] mt-0.5">Aprovado</div>
                </div>
            </div>

            {% if waiting_approval_share is not None %}
            <div class="text-[10px] text-gray-500 mt-2 flex items-center">
                <i class="fas fa-info-circle mr-1 text-indigo-400"></i>
                {{ waiting_approval_share }}% do pipeline está em aprovado
            </div>
            {% endif %}
        </div>

        <!-- Card 4: Encerradas (subtipos) -->
        <div class="kpi-card kpi-accent-4 rounded-xl shadow-md p-3 group">
            <div class="flex items-start justify-between mb-1.5">
                <div class="text-gray-600 text-[10px] uppercase tracking-wider font-bold">Encerradas</div>
                <div class="w-7 h-7 rounded-lg bg-blue-100 flex items-center justify-center group-hover:bg-blue-200 transition-colors duration-300 tooltip-custom" data-tooltip="OS finalizadas">
                    <i class="fas fa-check-circle text-blue-600 text-xs"></i>
                </div>
            </div>
            <div class="text-2xl font-bold kpi-value-4 mb-1.5">{{ completed_count }}</div>

            <div class="grid grid-cols-3 gap-1.5 text-xs">
                <div class="rounded-md bg-emerald-50 p-1.5 text-center border border-emerald-100 hover:bg-emerald-100 transition-colors duration-200">
                    <div class="font-bold text-emerald-600 text-sm">{{ completed_final_count }}</div>
                    <div class="text-gray-600 text-[10px] mt-0.5">Concluídas</div>
                </div>
                <div class="rounded-md bg-slate-50 p-1.5 text-center border border-slate-100 hover:bg-slate-100 transition-colors duration-200">
                    <div class="font-bold text-slate-600 text-sm">{{ financial_closed_count }}</div>
                    <div class="text-gray-600 text-[10px] mt-0.5">Financeiro</div>
                </div>
                <div class="rounded-md bg-rose-50 p-1.5 text-center border border-rose-100 hover:bg-rose-100 transition-colors duration-200">
                    <div class="font-bold text-rose-600 text-sm">{{ canceled_count }}</div>
                    <div class="text-gray-600 text-[10px] mt-0.5">Canceladas</div>
                </div>
            </div>
        </div>

    </div>



    <!-- ========== GRID PRINCIPAL: TOP PRESTADORES + CLIENTES MAIS ATIVOS + TOP 5 SERVIÇOS (MESMA LARGURA) ========== -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">

        <!-- COLUNA 1: Top Prestadores (33%) -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-xl shadow-md p-4 section-card border border-gray-100 h-74">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="section-title">
                        <div class="icon-badge-sm bg-gradient-to-br from-purple-500 to-purple-700 shadow-sm">
                            <i class="fas fa-star text-white text-xs"></i>
                        </div>
                        Top Prestadores
                    </h3>
                    <span class="section-subtitle tooltip-custom" data-tooltip="Baseado em avaliações dos clientes">Por Avaliação</span>
                </div>
                <div class="chart-container">
                    <canvas id="topProvidersChart"></canvas>
                </div>
            </div>
        </div>

        <!-- COLUNA 2: CLIENTES MAIS ATIVOS (33%) -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-xl shadow-md p-4 section-card border border-gray-100 h-full">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="section-title">
                        <div class="icon-badge-sm bg-gradient-to-br from-green-500 to-teal-600 shadow-sm">
                            <i class="fas fa-user-tie text-white text-xs"></i>
                        </div>
                        Clientes Mais Ativos
                    </h3>
                    <span class="section-subtitle tooltip-custom" data-tooltip="Clientes com mais ordens de serviço">Ranking</span>
                </div>
                <div class="chart-container">
                    <canvas id="topClientsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- COLUNA 3: Top 5 Serviços Mais Solicitados (33%) -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-xl shadow-md p-4 section-card border border-gray-100 h-full">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="section-title">
                        <div class="icon-badge-sm bg-gradient-to-br from-orange-500 to-amber-600 shadow-sm">
                            <i class="fas fa-chart-bar text-white text-xs"></i>
                        </div>
                        Top 5 Serviços
                    </h3>
                    <span class="section-subtitle tooltip-custom" data-tooltip="Serviços mais solicitados">Ranking</span>
                </div>
                <div class="chart-container">
                    <canvas id="topServicesChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== GRFICO TIMELINE (Barras Verticais - Últimos 12 meses) ========== -->
    <div class="bg-white rounded-xl shadow-md p-4 mb-4 section-card border border-gray-100 h-74">
        <div class="flex items-center justify-between mb-3">
            <h3 class="section-title">
                <div class="icon-badge-sm bg-gradient-to-br from-purple-500 to-indigo-600 shadow-sm">
                    <i class="fas fa-chart-line text-white text-xs"></i>
                </div>
                Atendimentos por Mês
            </h3>
            <span class="section-subtitle">Últimos 12 meses</span>
        </div>
        <div class="chart-container-sm">
            <canvas id="dailyChart"></canvas>
        </div>
    </div>


    <!-- ========== GRID SECUNDRIO: KPI + AGENDA + MAPA ========== -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 mb-4">

        <!-- COLUNA 1-3: KPI (Velocímetro) - 25% -->
        <div class="lg:col-span-3">
            <!-- KPI Operacional -->
            <div class="bg-gradient-to-br from-emerald-50 via-white to-slate-50 rounded-xl shadow-md p-4 section-card border border-emerald-100 h-74">
                <h3 class="section-title mb-3">
                    <div class="icon-badge-sm bg-gradient-to-br from-emerald-500 to-teal-600 shadow-sm">
                        <i class="fas fa-heart text-white text-xs"></i>
                    </div>
                    <span class="text-sm">Satisfacao do Cliente</span>
                </h3>

                <div class="satisfaction-speedo">
                    <svg class="speedo-svg" viewBox="0 0 200 120" aria-hidden="true">
                        <defs>
                            <linearGradient id="speedoGradient" x1="0" y1="0" x2="1" y2="0">
                                <stop offset="0%" stop-color="#EF4444"></stop>
                                <stop offset="55%" stop-color="#F59E0B"></stop>
                                <stop offset="100%" stop-color="#10B981"></stop>
                            </linearGradient>
                        </defs>
                        <path class="speedo-track" d="M20 100 A80 80 0 0 1 180 100"></path>
                        <path class="speedo-value" d="M20 100 A80 80 0 0 1 180 100" pathLength="100"></path>
                        <g class="speedo-ticks"></g>
                        <g class="speedo-needle">
                            <line x1="100" y1="100" x2="100" y2="30"></line>
                            <circle cx="100" cy="100" r="6"></circle>
                        </g>
                    </svg>
                    <div class="speedo-center">
                        <div class="speedo-value-text">{{ satisfaction_percent|floatformat:1 }}%</div>
                        <div class="speedo-subtext">{{ satisfaction_avg_rating|floatformat:1 }}/5</div>
                    </div>
                    <div class="speedo-labels">
                        <span>Baixa</span>
                        <span>Alta</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- COLUNA 4-6: Agenda + OS Pendentes - 25% -->
        <div class="lg:col-span-3">
            <div class="bg-white rounded-xl shadow-md p-4 section-card flex flex-col border border-gray-100 h-74">
                <div class="flex-1 mb-3">
                    <h3 class="section-title mb-3">
                        <div class="icon-badge-sm bg-gradient-to-br from-blue-500 to-blue-700 shadow-sm">
                            <i class="fas fa-calendar-alt text-white text-xs"></i>
                        </div>
                        Atendimentos em 24h
                    </h3>

                    <div class="table-header-modern rounded-t-lg px-2 py-2 mb-0 shadow-sm">
                        <div class="grid grid-cols-2 gap-1 text-[10px]">
                            <div>O.S.</div>
                            <div>Laudo</div>
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-b-lg px-2 py-1 border border-gray-200 border-t-0" style="max-height: 150px; overflow-y: auto;">
                        {% if upcoming_orders %}
                            {% for order in upcoming_orders %}
                                {% if order.status.name != "Pendente" and order.status.name != "Aberta" %}
                                <div class="grid grid-cols-2 gap-1 text-gray-700 text-[10px] py-2 border-b border-gray-200 last:border-0 table-row-modern">
                                    <div class="truncate font-semibold text-purple-600">{{ order.code|default:"-" }}</div>
                                    <div class="truncate">{{ order.technical_report|default:"-" }}</div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            <div class="text-[10px] text-gray-500 py-4 text-center flex flex-col items-center">
                                <i class="fas fa-inbox text-lg text-gray-300 mb-1"></i>
                                <span>Nenhum atendimento</span>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="bg-gradient-to-r from-blue-500 to-blue-700 rounded-lg p-3 text-center text-white shadow-md">
                    <div class="text-[10px] uppercase tracking-wider font-bold mb-1">OS Abertas</div>
                    <div class="text-xl font-bold">{{ pending_count }}</div>
                </div>
            </div>
        </div>

        <!-- COLUNA 7-12: Mapa de Pontos de Atendimento - 50% -->
        <div class="lg:col-span-6">
            <div class="bg-white rounded-xl shadow-md p-4 section-card border border-gray-100 h-74">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="section-title">
                        <div class="icon-badge-sm bg-gradient-to-br from-red-500 to-pink-600 shadow-sm">
                            <i class="fas fa-map-marker-alt text-white text-xs"></i>
                        </div>
                        Pontos de Atendimento
                    </h3>
                    <span class="section-subtitle tooltip-custom" data-tooltip="Localização das ordens de serviço">Mapa de Calor</span>
                </div>
                <div style="height: 200px;">
                    <div id="pointsMap" class="h-full rounded-lg shadow-inner"></div>
                </div>
            </div>
        </div>
    </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
// Aguardar o DOM estar completamente carregado
document.addEventListener('DOMContentLoaded', function() {

console.log('=== Dashboard Script Loaded ===');
console.log('Chart.js available:', typeof Chart !== 'undefined');
console.log('Leaflet available:', typeof L !== 'undefined');

// Verificar se Chart.js está disponível
if (typeof Chart === 'undefined') {
    console.error('ERRO: Chart.js não foi carregado!');
    alert('Erro: Chart.js não carregou. Verifique sua conexão com a internet.');
    return;
}

// ========== CONFIGURAÇÃO GLOBAL DOS GRFICOS ==========
Chart.defaults.color = '#374151';
Chart.defaults.borderColor = '#E5E7EB';
Chart.defaults.font.family = 'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
Chart.defaults.font.size = 13;

// ========== FUNÇÃO PARA CRIAR GAUGE ==========
function initSatisfactionSpeedometer(value) {
    const speedo = document.querySelector('.satisfaction-speedo');
    if (!speedo) return;

    const svg = speedo.querySelector('.speedo-svg');
    if (!svg) return;

    const path = svg.querySelector('.speedo-value');
    const needle = svg.querySelector('.speedo-needle');
    const ticksGroup = svg.querySelector('.speedo-ticks');

    const safeValue = Math.max(0, Math.min(100, Number(value) || 0));
    if (path) {
        path.style.strokeDasharray = `${safeValue} 100`;
    }
    if (needle) {
        const angle = -90 + (safeValue / 100) * 180;
        needle.style.transform = `rotate(${angle}deg)`;
    }

    if (ticksGroup && ticksGroup.children.length === 0) {
        const totalTicks = 11;
        const cx = 100;
        const cy = 100;
        const outer = 78;
        const inner = 68;
        const svgNs = 'http://www.w3.org/2000/svg';
        for (let i = 0; i < totalTicks; i++) {
            const t = document.createElementNS(svgNs, 'line');
            const angle = Math.PI * (1 - i / (totalTicks - 1));
            const x1 = cx + Math.cos(angle) * outer;
            const y1 = cy + Math.sin(angle) * outer;
            const x2 = cx + Math.cos(angle) * inner;
            const y2 = cy + Math.sin(angle) * inner;
            t.setAttribute('x1', x1.toFixed(2));
            t.setAttribute('y1', y1.toFixed(2));
            t.setAttribute('x2', x2.toFixed(2));
            t.setAttribute('y2', y2.toFixed(2));
            ticksGroup.appendChild(t);
        }
    }
}

// ========== SPEEDOMETRO DE SATISFACAO ==========
const satisfactionPercent = {{ satisfaction_percent_json|safe }};
initSatisfactionSpeedometer(satisfactionPercent);

// ========== GRFICO DE LINHA - ATENDIMENTOS POR MÊS (Últimos 12 meses) ==========
const dailyLabels = {{ daily_labels|safe }};
const dailyTotals = {{ daily_counts|safe }};
const dailyCompleted = {{ daily_completed_counts|safe }};

const dailyCanvas = document.getElementById('dailyChart');
if (dailyCanvas) {
    const ctx = dailyCanvas.getContext('2d');

    // Gradientes
    const totalGradient = ctx.createLinearGradient(0, 0, 0, 280);
    totalGradient.addColorStop(0, 'rgba(124, 58, 237, 0.4)');
    totalGradient.addColorStop(1, 'rgba(124, 58, 237, 0.02)');

    const completedGradient = ctx.createLinearGradient(0, 0, 0, 280);
    completedGradient.addColorStop(0, 'rgba(16, 185, 129, 0.35)');
    completedGradient.addColorStop(1, 'rgba(16, 185, 129, 0.02)');

    new Chart(dailyCanvas, {
        type: 'line',
        data: {
            labels: dailyLabels,
            datasets: [
                {
                    label: 'Total de O.S.',
                    data: dailyTotals,
                    borderColor: '#7C3AED',
                    backgroundColor: totalGradient,
                    fill: true,
                    tension: 0.4,
                    borderWidth: 3,
                    pointRadius: 5,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#7C3AED',
                    pointBorderColor: '#FFFFFF',
                    pointBorderWidth: 2,
                    pointHoverBackgroundColor: '#7C3AED',
                    pointHoverBorderColor: '#FFFFFF',
                    pointHoverBorderWidth: 3
                },
                {
                    label: 'O.S. Concluídas',
                    data: dailyCompleted,
                    borderColor: '#10B981',
                    backgroundColor: completedGradient,
                    fill: true,
                    tension: 0.4,
                    borderWidth: 3,
                    pointRadius: 5,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#10B981',
                    pointBorderColor: '#FFFFFF',
                    pointBorderWidth: 2,
                    pointHoverBackgroundColor: '#10B981',
                    pointHoverBorderColor: '#FFFFFF',
                    pointHoverBorderWidth: 3
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 15,
                        font: {
                            size: 13,
                            weight: '600'
                        }
                    }
                },
                tooltip: {
                    backgroundColor: '#FFFFFF',
                    titleColor: '#1F2937',
                    bodyColor: '#374151',
                    borderColor: '#E5E7EB',
                    borderWidth: 1,
                    padding: 12,
                    cornerRadius: 8,
                    displayColors: true,
                    boxPadding: 6
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0,
                        font: {
                            size: 12
                        }
                    },
                    grid: {
                        color: '#F3F4F6',
                        borderDash: [3, 3]
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            size: 12
                        }
                    }
                }
            }
        }
    });
}

// ========== TOP 5 PRESTADORES POR AVALIAÇÃO (Horizontal) ==========
const topProvidersLabels = {{ top_providers_names|safe }};
const topProvidersRatings = {{ top_providers_ratings|safe }};

const topProvidersCanvas = document.getElementById('topProvidersChart');
if (topProvidersCanvas) {
    // Paleta harmônica: Gradiente purple para cada prestador
    const topProvidersColors = topProvidersRatings.map((value, index) => {
        const purpleShades = ['#7C3AED', '#8B5CF6', '#A78BFA', '#C4B5FD', '#DDD6FE'];
        return purpleShades[index % purpleShades.length];
    });

    new Chart(topProvidersCanvas, {
        type: 'bar',
        data: {
            labels: topProvidersLabels,
            datasets: [{
                label: 'Média de Avaliação',
                data: topProvidersRatings,
                backgroundColor: topProvidersColors,
                borderRadius: 10,
                borderSkipped: false,
                barThickness: 'flex',
                maxBarThickness: 40
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    min: 0,
                    max: 5,
                    ticks: {
                        stepSize: 1,
                        font: {
                            size: 12
                        }
                    },
                    grid: {
                        color: '#F3F4F6'
                    }
                },
                y: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            size: 12,
                            weight: '600'
                        }
                    }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#FFFFFF',
                    titleColor: '#1F2937',
                    bodyColor: '#374151',
                    borderColor: '#E5E7EB',
                    borderWidth: 1,
                    padding: 12,
                    cornerRadius: 8,
                    callbacks: {
                        label: (ctx) => ` Avaliação: ${ctx.parsed.x.toFixed(1)} / 5.0`
                    }
                }
            }
        }
    });
}

// ========== CLIENTES MAIS ATIVOS (NOVO WIDGET - Horizontal) ==========
const topClientsLabels = {{ top_clients_labels|safe }};
const topClientsOrders = {{ top_clients_orders|safe }};

const topClientsCanvas = document.getElementById('topClientsChart');
if (topClientsCanvas) {
    // Cores vibrantes em tons de verde/teal
    const topClientsColors = topClientsOrders.map((value, index) => {
        const greenShades = ['#10B981', '#14B8A6', '#34D399', '#5EEAD4', '#6EE7B7'];
        return greenShades[index % greenShades.length];
    });

    if (!topClientsLabels.length || !topClientsOrders.length) {
        topClientsCanvas.parentElement.innerHTML = '<div class="text-sm text-gray-500 flex items-center justify-center h-full">Sem dados de clientes</div>';
    } else {
        new Chart(topClientsCanvas, {
            type: 'bar',
            data: {
                labels: topClientsLabels,
                datasets: [{
                    label: 'Número de O.S.',
                    data: topClientsOrders,
                    backgroundColor: topClientsColors,
                    borderRadius: 10,
                    borderSkipped: false,
                    barThickness: 'flex',
                    maxBarThickness: 40
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0,
                            font: {
                                size: 12
                            }
                        },
                        grid: {
                            color: '#F3F4F6'
                        }
                    },
                    y: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: 12,
                                weight: '600'
                            }
                        }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#FFFFFF',
                        titleColor: '#1F2937',
                        bodyColor: '#374151',
                        borderColor: '#E5E7EB',
                        borderWidth: 1,
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            label: (ctx) => ` Total: ${ctx.parsed.x} ordens de serviço`
                        }
                    }
                }
            }
        });
    }
}

// ========== TOP 5 SERVIÇOS MAIS SOLICITADOS (HORIZONTAL - RANKING DESCENDENTE) ==========
const topServicesLabels = {{ top_services_labels|safe }};
const topServicesCounts = {{ top_services_counts|safe }};
const topServicesCanvas = document.getElementById('topServicesChart');

if (topServicesCanvas && topServicesLabels && topServicesCounts) {
    // Ordenar os dados em ordem descendente (maior para menor)
    const combinedData = topServicesLabels.map((label, index) => ({
        label: label,
        count: topServicesCounts[index]
    }));

    // Ordenar descendente
    combinedData.sort((a, b) => b.count - a.count);

    // Extrair labels e counts ordenados
    const sortedLabels = combinedData.map(item => item.label);
    const sortedCounts = combinedData.map(item => item.count);

    // Cores vibrantes em tons de laranja/vermelho
    const topServicesColors = sortedCounts.map((value, index) => {
        const orangeShades = ['#F59E0B', '#FB923C', '#FBBF24', '#FCD34D', '#FDE68A'];
        return orangeShades[index % orangeShades.length];
    });

    // Criar gráfico apenas uma vez
    new Chart(topServicesCanvas, {
        type: 'bar',
        data: {
            labels: sortedLabels,
            datasets: [{
                label: 'Solicitações',
                data: sortedCounts,
                backgroundColor: topServicesColors,
                hoverBackgroundColor: topServicesColors.map(color => color),
                borderRadius: 10,
                borderSkipped: false,
                barThickness: 'flex',
                maxBarThickness: 45
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0,
                        font: {
                            size: 12
                        }
                    },
                    grid: {
                        color: '#F3F4F6'
                    }
                },
                y: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            size: 12,
                            weight: '600'
                        }
                    }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#FFFFFF',
                    titleColor: '#1F2937',
                    bodyColor: '#374151',
                    borderColor: '#E5E7EB',
                    borderWidth: 1,
                    padding: 12,
                    cornerRadius: 8,
                    callbacks: {
                        label: (ctx) => ` Total: ${ctx.parsed.x} solicitações`
                    }
                }
            }
        }
    });
}

// ========== MAPA DE PONTOS DE ATENDIMENTO ==========
const pointsMapEl = document.getElementById('pointsMap');
if (pointsMapEl && typeof L !== 'undefined') {
    const defaultCenter = [-22.785, -43.310];
    const pointsMap = L.map('pointsMap').setView(defaultCenter, 11);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 18
    }).addTo(pointsMap);

    const clusterGroup = L.markerClusterGroup({
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: true,
        zoomToBoundsOnClick: true
    });

    fetch('/api/dashboard/mapa-sla/')
        .then(res => res.json())
        .then(result => {
            if (!result.success) {
                console.error('Erro ao carregar pontos:', result.error);
                return;
            }
            const points = result.data || [];
            if (!points.length) {
                console.info('Nenhum ponto de atendimento encontrado');
                return;
            }

            let sumLat = 0;
            let sumLng = 0;

            points.forEach(point => {
                sumLat += point.lat;
                sumLng += point.lng;

                const marker = L.marker([point.lat, point.lng], {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: '<div style="background: #7C3AED; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                        iconSize: [12, 12]
                    })
                });

                marker.bindPopup(`
                    <div class="text-sm p-2">
                        <div class="font-bold text-purple-700 text-base mb-2">O.S. ${point.code}</div>
                        <div class="space-y-1">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-user text-gray-500 w-4"></i>
                                <span><strong>Cliente:</strong> ${point.client_name}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-wrench text-gray-500 w-4"></i>
                                <span><strong>Serviço:</strong> ${point.service_type}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-info-circle text-gray-500 w-4"></i>
                                <span><strong>Status:</strong> ${point.status}</span>
                            </div>
                        </div>
                    </div>
                `, {
                    maxWidth: 300,
                    className: 'custom-popup'
                });

                clusterGroup.addLayer(marker);
            });

            pointsMap.addLayer(clusterGroup);

            if (points.length > 0) {
                const center = [sumLat / points.length, sumLng / points.length];
                pointsMap.setView(center, 11);
            }
        })
        .catch(err => console.error('Erro ao carregar mapa:', err));
}

console.log('=== Dashboard Carregado com Sucesso ===');

}); // Fim do DOMContentLoaded
</script>
{% endblock %}


