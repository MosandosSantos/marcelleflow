{% extends 'base/base.html' %}
{% load l10n %}

{% block title %}Dashboard Operacional - EsferaWork{% endblock %}
{% block page_title %}Dashboard Operacional{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
{% endblock %}

{% block content %}
<div class="space-y-8">
  <!-- KPI Cards -->
  <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-5">
    <div class="rounded-2xl bg-white p-6 shadow-lg border border-slate-200">
      <div class="flex items-start justify-between">
        <div>
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Total OS</p>
          <p class="mt-2 text-3xl font-bold text-purple-700">{{ total_orders }}</p>
        </div>
        <div class="rounded-full bg-purple-100 p-3">
          <i class="fas fa-clipboard-list text-purple-700 text-xl"></i>
        </div>
      </div>
    </div>

    <div class="rounded-2xl bg-white p-6 shadow-lg border border-slate-200">
      <div class="flex items-start justify-between">
        <div>
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Em Andamento</p>
          <p class="mt-2 text-3xl font-bold text-blue-600">{{ in_progress_count }}</p>
        </div>
        <div class="rounded-full bg-blue-100 p-3">
          <i class="fas fa-spinner text-blue-600 text-xl"></i>
        </div>
      </div>
    </div>

    <div class="rounded-2xl bg-white p-6 shadow-lg border border-slate-200">
      <div class="flex items-start justify-between">
        <div>
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Concluídas</p>
          <p class="mt-2 text-3xl font-bold text-green-600">{{ completed_count }}</p>
        </div>
        <div class="rounded-full bg-green-100 p-3">
          <i class="fas fa-check-circle text-green-600 text-xl"></i>
        </div>
      </div>
    </div>

    <div class="rounded-2xl bg-white p-6 shadow-lg border border-slate-200">
      <div class="flex items-start justify-between">
        <div>
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Prestadores</p>
          <p class="mt-2 text-3xl font-bold text-indigo-600">{{ total_providers }}</p>
        </div>
        <div class="rounded-full bg-indigo-100 p-3">
          <i class="fas fa-users text-indigo-600 text-xl"></i>
        </div>
      </div>
    </div>

    <div class="rounded-2xl bg-white p-6 shadow-lg border border-slate-200">
      <div class="flex items-start justify-between">
        <div>
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Clientes</p>
          <p class="mt-2 text-3xl font-bold text-cyan-600">{{ total_clients }}</p>
        </div>
        <div class="rounded-full bg-cyan-100 p-3">
          <i class="fas fa-building text-cyan-600 text-xl"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Top Prestadores -->
  <div class="rounded-2xl bg-white p-6 shadow-lg border border-slate-200">
    <h3 class="text-xl font-bold text-slate-900 mb-4">Top 10 Prestadores</h3>
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead class="bg-purple-700 text-white">
          <tr>
            <th class="px-6 py-3 text-left">Prestador</th>
            <th class="px-6 py-3 text-center">OS Concluídas</th>
            <th class="px-6 py-3 text-center">Avaliação</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-200">
          {% for provider in top_providers %}
          <tr class="hover:bg-slate-50">
            <td class="px-6 py-4 font-medium">{{ provider.full_name }}</td>
            <td class="px-6 py-4 text-center">{{ provider.completed_count }}</td>
            <td class="px-6 py-4 text-center">
              <span class="inline-flex items-center gap-1 rounded-full bg-yellow-100 px-3 py-1 text-xs font-semibold text-yellow-800">
                <i class="fas fa-star"></i>
                {{ provider.avg_rating|floatformat:1 }}
              </span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Próximas Ordens -->
  <div class="rounded-2xl bg-white p-6 shadow-lg border border-slate-200">
    <h3 class="text-xl font-bold text-slate-900 mb-4">Próximas Ordens Agendadas</h3>
    <div class="space-y-4">
      {% for order in upcoming_orders %}
      <div class="flex items-center justify-between p-4 rounded-lg border border-slate-200 hover:bg-slate-50">
        <div class="flex-1">
          <p class="font-semibold text-slate-900">{{ order.service_type.name }}</p>
          <p class="text-sm text-slate-600">Cliente: {{ order.client.company_name }}</p>
          <p class="text-xs text-slate-500">Prestador: {{ order.provider.full_name }}</p>
        </div>
        <div class="text-right">
          <p class="text-sm font-semibold text-purple-700">{{ order.scheduled_date|date:"d/m/Y" }}</p>
          <p class="text-xs text-slate-500">{{ order.scheduled_time|time:"H:i" }}</p>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Gráfico de Status -->
  <div class="rounded-2xl bg-white p-6 shadow-lg border border-slate-200">
    <h3 class="text-xl font-bold text-slate-900 mb-4">Distribuição por Status</h3>
    <canvas id="statusChart" height="100"></canvas>
  </div>

</div>

<script>
  const ctx = document.getElementById('statusChart');
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: {{ status_labels|safe }},
      datasets: [{
        data: {{ status_values|safe }},
        backgroundColor: [
          '#8B5CF6',
          '#3B82F6',
          '#10B981',
          '#F59E0B',
          '#EF4444'
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });
</script>
{% endblock %}
