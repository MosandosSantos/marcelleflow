{% extends 'base/base.html' %}
{% block title %}Faturamento - EsferaFlow{% endblock %}
{% block page_title %}Faturamento{% endblock %}

{% block content %}
<div class="mb-6 rounded-3xl bg-gradient-to-br from-indigo-500 via-purple-500 to-slate-800 text-white p-6 md:p-8 shadow-xl">
  <div class="flex flex-wrap justify-between items-start gap-6">
    <div class="space-y-2">
      <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold bg-white/10 text-white/80">
        <span class="inline-block w-2 h-2 rounded-full bg-emerald-300"></span>
        Faturamento
      </div>
      <h2 class="text-3xl md:text-4xl font-extrabold tracking-tight">Ciclo de OS e NF</h2>
      <p class="text-sm md:text-base text-white/80 max-w-2xl">
        Acompanhe as OS encerradas, parcelas aguardando NF e notas fiscais emitidas.
      </p>
    </div>
  </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
  <div class="bg-white rounded-xl shadow-md p-4 border border-gray-100">
    <p class="text-xs uppercase text-gray-500">OS encerradas</p>
    <p class="text-xl font-bold text-gray-800 mt-2">{{ total_without_nf }}</p>
    <p class="text-xs text-gray-500 mt-1">Total encerradas</p>
  </div>
  <div class="bg-white rounded-xl shadow-md p-4 border border-orange-100">
    <p class="text-xs uppercase text-gray-500">Aguardando NF</p>
    <p class="text-xl font-bold text-orange-600 mt-2">{{ awaiting_nf_installments|length }}</p>
    <p class="text-xs text-gray-500 mt-1">Parcelas sem NF emitida</p>
  </div>
  <div class="bg-white rounded-xl shadow-md p-4 border border-indigo-100">
    <p class="text-xs uppercase text-gray-500">NF abertas</p>
    <p class="text-xl font-bold text-indigo-600 mt-2">{{ nfs_open_installments|length }}</p>
    <p class="text-xs text-gray-500 mt-1">Emitidas e nao pagas</p>
  </div>
  <div class="bg-white rounded-xl shadow-md p-4 border border-green-100">
    <p class="text-xs uppercase text-gray-500">NF fechadas</p>
    <p class="text-xl font-bold text-green-600 mt-2">{{ nfs_closed_installments|length }}</p>
    <p class="text-xs text-gray-500 mt-1">Emitidas e pagas</p>
  </div>
</div>

<div class="bg-white rounded-xl shadow-md p-4 border border-gray-100 mb-6">
  <div class="flex flex-wrap items-center gap-3">
    <span class="text-sm font-semibold text-gray-700">Visualizacao:</span>
    <div class="flex flex-wrap items-center gap-2">
      <button type="button" class="px-4 py-2 rounded-lg text-sm font-semibold bg-slate-100 text-slate-700 hover:bg-slate-200 transition-colors" data-billing-target="os">
        OS encerradas
      </button>
      <button type="button" class="px-4 py-2 rounded-lg text-sm font-semibold bg-orange-100 text-orange-700 hover:bg-orange-200 transition-colors" data-billing-target="awaiting">
        Aguardando NF
      </button>
      <button type="button" class="px-4 py-2 rounded-lg text-sm font-semibold bg-indigo-100 text-indigo-700 hover:bg-indigo-200 transition-colors" data-billing-target="open">
        NF abertas
      </button>
      <button type="button" class="px-4 py-2 rounded-lg text-sm font-semibold bg-emerald-100 text-emerald-700 hover:bg-emerald-200 transition-colors" data-billing-target="closed">
        NF fechadas
      </button>
    </div>
  </div>
</div>

<div id="billingTableOs" data-billing-table="os">
<div class="bg-white rounded-xl shadow-md overflow-hidden">
  {% if orders %}
  <div class="overflow-x-auto">
    <table class="w-full">
      <thead class="bg-gray-50">
        <tr>
          <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Codigo</th>
          <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Cliente</th>
          <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Servico</th>
                    <th class="text-right py-4 px-6 text-sm font-semibold text-gray-700">Valor</th>
          <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Encerrada em</th>
          <th class="text-center py-4 px-6 text-sm font-semibold text-gray-700">Acoes</th>
        </tr>
      </thead>
      <tbody>
        {% for order in orders %}
        <tr class="border-t hover:bg-gray-50 transition-colors">
          <td class="py-4 px-6 text-sm text-gray-700">{{ order.code }}</td>
          <td class="py-4 px-6 text-sm text-gray-700">{{ order.client.full_name|default:"-" }}</td>
          <td class="py-4 px-6 text-sm text-gray-700">{{ order.service_type.name|default:"-" }}</td>
                    <td class="py-4 px-6 text-sm text-gray-700 text-right">R$ {{ order.labor_cost|default:"0.00" }}</td>
          <td class="py-4 px-6 text-sm text-gray-700">
            {% if order.finished_at %}{{ order.finished_at|date:"d/m/Y" }}{% else %}-{% endif %}
          </td>
          <td class="py-4 px-6 text-center">
            <a href="{% url 'workorder:detail' order.id %}" class="text-gray-600 hover:text-gray-800" title="Ver OS">
              <i class="fas fa-eye"></i>
            </a>
            <a
              href="{% url 'finance:workorder_payment' order.id %}"
              class="ml-3 inline-flex items-center {% if order.finished_at or order.closed_on %}text-emerald-600 hover:text-emerald-800{% else %}text-gray-300 hover:text-gray-400{% endif %}"
              title="{% if order.finished_at or order.closed_on %}Gerar pagamento{% else %}OS sem data de término{% endif %}"
            >
              <i class="fas fa-credit-card"></i>
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% if is_paginated %}
  <div class="px-6 py-4 border-t flex justify-between items-center">
    <span class="text-sm text-gray-600">
      Mostrando {{ orders|length }} de {{ page_obj.paginator.count }} OS
      (Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }})
    </span>
    <div class="space-x-2">
      {% if page_obj.has_previous %}
      <a href="?page=1" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 transition-colors">
        <i class="fas fa-angle-double-left"></i>
      </a>
      <a href="?page={{ page_obj.previous_page_number }}" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 transition-colors">
        <i class="fas fa-angle-left"></i> Anterior
      </a>
      {% endif %}

      <span class="px-4 py-2 bg-primary text-white rounded">
        {{ page_obj.number }}
      </span>

      {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 transition-colors">
        Próxima <i class="fas fa-angle-right"></i>
      </a>
      <a href="?page={{ page_obj.paginator.num_pages }}" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 transition-colors">
        <i class="fas fa-angle-double-right"></i>
      </a>
      {% endif %}
    </div>
  </div>
  {% endif %}
  {% else %}
  <div class="text-center py-12 text-gray-500">
    <i class="fas fa-file-invoice text-5xl mb-4"></i>
    <p class="text-lg font-semibold mb-2">Nenhuma OS pendente de NF</p>
    <p class="text-sm">Todas as OS encerradas possuem NF emitida.</p>
  </div>
  {% endif %}
</div>
</div>

<div id="billingTableAwaiting" class="hidden mt-8 bg-white rounded-xl shadow-md overflow-hidden" data-billing-table="awaiting">
  <div class="px-6 py-4 border-b flex items-center justify-between">
    <div>
      <h3 class="text-lg font-semibold text-gray-800">Aguardando NF</h3>
      <p class="text-sm text-gray-500">Lista de NFs emitidas (módulo em desenvolvimento).</p>
    </div>
  </div>
  {% if awaiting_nf_installments %}
  <div class="overflow-x-auto">
    <table class="w-full">
      <thead class="bg-gray-50">
        <tr>
          <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">OS</th>
          <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Cliente</th>
          <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Servico</th>
          <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Parcela</th>
          <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Vencimento</th>
          <th class="text-right py-4 px-6 text-sm font-semibold text-gray-700">Valor</th>
          <th class="text-center py-4 px-6 text-sm font-semibold text-gray-700">Acoes</th>
</tr>
      </thead>
      <tbody>

        {% for parcela in awaiting_nf_installments %}
        <tr class="border-t hover:bg-gray-50 transition-colors">
          <td class="py-4 px-6 text-sm text-gray-700">{{ parcela.work_order.code }}</td>
          <td class="py-4 px-6 text-sm text-gray-700">{{ parcela.work_order.client.full_name|default:"-" }}</td>
          <td class="py-4 px-6 text-sm text-gray-700">{{ parcela.work_order.service_type.name|default:"-" }}</td>
          <td class="py-4 px-6 text-sm text-gray-700">{{ parcela.installment_number }}/{{ parcela.installment_total }}</td>
          <td class="py-4 px-6 text-sm text-gray-700">{{ parcela.data_vencimento|date:"d/m/Y" }}</td>
          <td class="py-4 px-6 text-sm text-gray-700 text-right">R$ {{ parcela.valor|floatformat:2 }}</td>
          <td class="py-4 px-6 text-center">
            <a href="{% url 'workorder:detail' parcela.work_order.id %}" class="text-gray-600 hover:text-gray-800" title="Ver OS">
              <i class="fas fa-eye"></i>
            </a>
            <a href="{% url 'finance:installment_nf' parcela.id %}" class="ml-3 text-indigo-600 hover:text-indigo-800" title="Gerar NF/Boleto">
              <i class="fas fa-file-invoice"></i>
            </a>
          </td>
        </tr>
        {% endfor %}

      </tbody>
    </table>
  </div>
  {% else %}
  <div class="text-center py-10 text-gray-500">
    <i class="fas fa-file-invoice text-4xl mb-3"></i>
    <p class="text-sm">Nenhuma parcela aguardando NF.</p>
  </div>
  {% endif %}
</div>

<div id="billingTableOpen" class="hidden mt-8 bg-white rounded-xl shadow-md overflow-hidden" data-billing-table="open">
  <div class="px-6 py-4 border-b flex items-center justify-between">
    <div>
      <h3 class="text-lg font-semibold text-gray-800">NF abertas</h3>
      <p class="text-sm text-gray-500">NFs emitidas e ainda n?o pagas.</p>
    </div>
  </div>
  {% if nfs_open_installments %}
  <div class="overflow-x-auto">
    <table class="w-full">
      <thead class="bg-gray-50">
        <tr>
          <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">NF</th>
          <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">OS</th>
          <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Cliente</th>
          <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Parcela</th>
          <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Emiss?o</th>
          <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Vencimento</th>
          <th class="text-right py-4 px-6 text-sm font-semibold text-gray-700">Valor</th>
          <th class="text-center py-4 px-6 text-sm font-semibold text-gray-700">Acoes</th>
        </tr>
      </thead>
      <tbody>
        {% for nf in nfs_open_installments %}
        <tr class="border-t hover:bg-gray-50 transition-colors">
          <td class="py-4 px-6 text-sm text-gray-700">{{ nf.invoice_number|default:"-" }}</td>
          <td class="py-4 px-6 text-sm text-gray-700">{{ nf.work_order.code }}</td>
          <td class="py-4 px-6 text-sm text-gray-700">{{ nf.work_order.client.full_name|default:"-" }}</td>
          <td class="py-4 px-6 text-sm text-gray-700">{{ nf.installment_number }}/{{ nf.installment_total }}</td>
          <td class="py-4 px-6 text-sm text-gray-700">{{ nf.invoice_issued_at|date:"d/m/Y" }}</td>
          <td class="py-4 px-6 text-sm text-gray-700">{{ nf.data_vencimento|date:"d/m/Y" }}</td>
          <td class="py-4 px-6 text-sm text-gray-700 text-right">R$ {{ nf.valor|floatformat:2 }}</td>
          <td class="py-4 px-6 text-center">
            <a href="{% url 'finance:installment_nf' nf.id %}" class="text-indigo-600 hover:text-indigo-800" title="Ver NF/Boleto">
              <i class="fas fa-file-invoice"></i>
            </a>
            <a href="{% url 'finance:transaction_mark_completed' nf.id %}?next={% url 'finance:billing_orders' %}" class="ml-3 text-emerald-600 hover:text-emerald-800" title="Registrar pagamento">
              <i class="fas fa-check-circle"></i>
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="text-center py-10 text-gray-500">
    <i class="fas fa-file-invoice text-4xl mb-3"></i>
    <p class="text-sm">Nenhuma NF aberta.</p>
  </div>
  {% endif %}
</div>

</div>

<div id="billingTableClosed" class="hidden mt-8 bg-white rounded-xl shadow-md overflow-hidden" data-billing-table="closed">
  <div class="px-6 py-4 border-b flex items-center justify-between">
    <div>
      <h3 class="text-lg font-semibold text-gray-800">NF Fechadas</h3>
      <p class="text-sm text-gray-500">Notas fiscais pagas/encerradas (módulo em desenvolvimento).</p>
    </div>
  </div>
  {% if nfs_closed_installments %}
  <div class="overflow-x-auto">
    <table class="w-full">
      <thead class="bg-gray-50">
        <tr>
          <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Número</th>
          <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Cliente</th>
          <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">OS</th>
          <th class="text-right py-4 px-6 text-sm font-semibold text-gray-700">Valor</th>
          <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Pagamento</th>
          <th class="text-center py-4 px-6 text-sm font-semibold text-gray-700">Status</th>
        </tr>
      </thead>
      <tbody>
        {% for nf in nfs_closed_installments %}
        <tr class="border-t hover:bg-gray-50 transition-colors">
          <td class="py-4 px-6 text-sm text-gray-700">{{ nf.invoice_number|default:"-" }}</td>
          <td class="py-4 px-6 text-sm text-gray-700">{{ nf.work_order.client.full_name|default:"-" }}</td>
          <td class="py-4 px-6 text-sm text-gray-700">{{ nf.work_order.code }}</td>
          <td class="py-4 px-6 text-sm text-gray-700 text-right">R$ {{ nf.valor|floatformat:2 }}</td>
          <td class="py-4 px-6 text-sm text-gray-700">{{ nf.data_pagamento|date:"d/m/Y" }}</td>
          <td class="py-4 px-6 text-center text-sm text-gray-700">{{ nf.get_status_display }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="text-center py-10 text-gray-500">
    <i class="fas fa-check-circle text-4xl mb-3"></i>
    <p class="text-sm">Nenhuma NF fechada.</p>
  </div>
  {% endif %}
</div>

<script>
  (function () {
    const tables = document.querySelectorAll('[data-billing-table]');
    const buttons = document.querySelectorAll('[data-billing-target]');
    if (!tables.length || !buttons.length) return;

    function showTable(key) {
      tables.forEach((table) => {
        table.classList.toggle('hidden', table.dataset.billingTable !== key);
      });
      buttons.forEach((btn) => {
        const active = btn.dataset.billingTarget === key;
        btn.classList.toggle('ring-2', active);
        btn.classList.toggle('ring-primary', active);
      });
    }

    buttons.forEach((btn) => {
      btn.addEventListener('click', () => showTable(btn.dataset.billingTarget));
    });
    showTable('os');
  })();
</script>
{% endblock %}
