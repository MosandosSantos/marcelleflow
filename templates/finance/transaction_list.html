{% extends 'base/base.html' %}
{% load finance_extras %}
{% block title %}Lancamentos Financeiros - EsferaFlow{% endblock %}
{% block page_title %}Lancamentos Financeiros{% endblock %}
{% block content %}
<div class="mb-6">
  <div class="flex flex-wrap justify-between items-center gap-4">
    <div>
      <h2 class="text-2xl font-bold text-gray-800">Lancamentos Financeiros</h2>
      <p class="text-sm text-gray-500">Controle completo de receitas e despesas</p>
    </div>
    <a
      href="{% url 'finance:transaction_create' %}"
      class="px-6 py-3 bg-primary text-white rounded-lg font-semibold hover:bg-purple-700 transition-colors"
    >
      <i class="fas fa-plus mr-2"></i>Novo lançamento
    </a>
  </div>
  {% include 'finance/_submenu.html' %}
</div>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
  <div class="bg-white rounded-xl shadow-md p-4 border border-gray-100 hover:shadow-lg transition-shadow">
    <div class="flex items-center justify-between">
      <p class="text-xs uppercase text-gray-500">Saldo atual</p>
      <span class="w-9 h-9 rounded-full bg-gray-100 text-gray-700 flex items-center justify-center">
        <i class="fas fa-wallet"></i>
      </span>
    </div>
    <p class="text-xl font-bold text-gray-800 mt-2">R$ {{ stats.saldo_atual|brl }}</p>
  </div>
  <div class="bg-white rounded-xl shadow-md p-4 border border-green-100 hover:shadow-lg transition-shadow">
    <div class="flex items-center justify-between">
      <p class="text-xs uppercase text-gray-500">Receitas realizadas</p>
      <span class="w-9 h-9 rounded-full bg-green-100 text-green-700 flex items-center justify-center">
        <i class="fas fa-arrow-up"></i>
      </span>
    </div>
    <p class="text-xl font-bold text-green-600 mt-2">R$ {{ stats.total_receitas|brl }}</p>
  </div>
  <div class="bg-white rounded-xl shadow-md p-4 border border-red-100 hover:shadow-lg transition-shadow">
    <div class="flex items-center justify-between">
      <p class="text-xs uppercase text-gray-500">Despesas</p>
      <span class="w-9 h-9 rounded-full bg-red-100 text-red-700 flex items-center justify-center">
        <i class="fas fa-arrow-down"></i>
      </span>
    </div>
    <p class="text-xl font-bold text-red-500 mt-2">R$ {{ stats.total_despesas|brl }}</p>
  </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
  <div class="bg-white rounded-xl shadow-md p-4 border border-blue-100 hover:shadow-lg transition-shadow">
    <div class="flex items-center justify-between">
      <p class="text-xs uppercase text-gray-500">Receitas a receber</p>
      <span class="w-9 h-9 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center">
        <i class="fas fa-calendar-check"></i>
      </span>
    </div>
    <p class="text-xl font-bold text-blue-600 mt-2">R$ {{ stats.receitas_a_receber|brl }}</p>
    <p class="text-xs text-gray-500 mt-1">Previstas e em atraso</p>
  </div>
  <div class="bg-white rounded-xl shadow-md p-4 border border-orange-100 hover:shadow-lg transition-shadow">
    <div class="flex items-center justify-between">
      <p class="text-xs uppercase text-gray-500">Despesas em atraso</p>
      <span class="w-9 h-9 rounded-full bg-orange-100 text-orange-700 flex items-center justify-center">
        <i class="fas fa-exclamation-triangle"></i>
      </span>
    </div>
    <p class="text-xl font-bold text-orange-600 mt-2">R$ {{ stats.despesas_em_atraso|brl }}</p>
    <p class="text-xs text-gray-500 mt-1">Vencidas e não pagas</p>
  </div>
  <div class="bg-white rounded-xl shadow-md p-4 border border-purple-100 hover:shadow-lg transition-shadow">
    <div class="flex items-center justify-between">
      <p class="text-xs uppercase text-gray-500">Saldo projetado</p>
      <span class="w-9 h-9 rounded-full bg-purple-100 text-purple-700 flex items-center justify-center">
        <i class="fas fa-chart-line"></i>
      </span>
    </div>
    <p class="text-xl font-bold text-purple-600 mt-2">R$ {{ stats.saldo_projetado|brl }}</p>
    <p class="text-xs text-gray-500 mt-1">Saldo atual + pendências</p>
  </div>
</div>

<div class="bg-white rounded-xl shadow-md p-6 mb-6">
  <form method="get" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
    <div>
      <label class="block text-xs font-semibold text-gray-600 mb-1">Tipo</label>
      {{ filter_form.tipo }}
    </div>
    <div>
      <label class="block text-xs font-semibold text-gray-600 mb-1">Status</label>
      {{ filter_form.status }}
    </div>
    <div>
      <label class="block text-xs font-semibold text-gray-600 mb-1">Parcelas</label>
      {{ filter_form.is_installment }}
    </div>
    <div>
      <label class="block text-xs font-semibold text-gray-600 mb-1">Origem</label>
      {{ filter_form.payment_origin }}
    </div>
    <div>
      <label class="block text-xs font-semibold text-gray-600 mb-1">Recorrência</label>
      {{ filter_form.is_recurring }}
    </div>
    <div>
      <label class="block text-xs font-semibold text-gray-600 mb-1">Período</label>
      {{ filter_form.recurrence_period }}
    </div>
    <div>
      <label class="block text-xs font-semibold text-gray-600 mb-1">Conta</label>
      {{ filter_form.account }}
    </div>
    <div>
      <label class="block text-xs font-semibold text-gray-600 mb-1">Categoria</label>
      {{ filter_form.category }}
    </div>
    <div>
      <label class="block text-xs font-semibold text-gray-600 mb-1">Data inicio</label>
      {{ filter_form.data_inicio }}
    </div>
    <div>
      <label class="block text-xs font-semibold text-gray-600 mb-1">Data fim</label>
      {{ filter_form.data_fim }}
    </div>
    <div class="md:col-span-2 lg:col-span-6">
      <label class="block text-xs font-semibold text-gray-600 mb-1">Buscar</label>
      {{ filter_form.search }}
    </div>
    <div class="flex items-end gap-2">
      <button
        type="submit"
        class="px-6 py-3 bg-primary text-white rounded-lg font-semibold hover:bg-purple-700 transition-colors"
      >
        <i class="fas fa-search mr-2"></i>Filtrar
      </button>
      <a
        href="{% url 'finance:transaction_list' %}"
        class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-colors"
      >
        <i class="fas fa-eraser mr-2"></i>Limpar
      </a>
    </div>
  </form>
</div>

<div class="bg-white rounded-xl shadow-md overflow-hidden">
  {% if transactions %}
  <div class="overflow-x-auto">
    <table class="w-full">
      <thead class="bg-purple-600">
        <tr>
          <th class="text-left py-4 px-6 text-sm font-semibold text-white">Vencimento</th>
          <th class="text-left py-4 px-6 text-sm font-semibold text-white">Descricao</th>
          <th class="text-left py-4 px-6 text-sm font-semibold text-white">Tipo</th>
          <th class="text-left py-4 px-6 text-sm font-semibold text-white">Categoria</th>
          <th class="text-left py-4 px-6 text-sm font-semibold text-white">Conta</th>
          <th class="text-left py-4 px-6 text-sm font-semibold text-white">Parcela</th>
          <th class="text-left py-4 px-6 text-sm font-semibold text-white">Origem</th>
          <th class="text-left py-4 px-6 text-sm font-semibold text-white">Recorrência</th>
          <th class="text-left py-4 px-6 text-sm font-semibold text-white">Valor</th>
          <th class="text-left py-4 px-6 text-sm font-semibold text-white">Status</th>
          <th class="text-center py-4 px-6 text-sm font-semibold text-white">Acoes</th>
        </tr>
      </thead>
      <tbody>
        {% for transaction in transactions %}
        <tr class="{% cycle 'bg-white' 'bg-purple-50/40' %} border-t hover:bg-purple-50/70 transition-colors {% if transaction.status == 'atrasado' %}text-red-600{% endif %}">
          <td class="py-4 px-6 text-sm {% if transaction.status == 'atrasado' %}text-red-600{% else %}text-gray-700{% endif %}">
            {{ transaction.data_vencimento|date:"d/m/Y" }}
          </td>
          <td class="py-4 px-6 font-semibold {% if transaction.status == 'atrasado' %}text-red-700{% else %}text-gray-800{% endif %}">
            {{ transaction.descricao }}
          </td>
          <td class="py-4 px-6 text-sm {% if transaction.status == 'atrasado' %}text-red-600{% else %}text-gray-600{% endif %}">
            {{ transaction.get_tipo_display }}
          </td>
          <td class="py-4 px-6 text-sm {% if transaction.status == 'atrasado' %}text-red-600{% else %}text-gray-600{% endif %}">
            {{ transaction.category.nome }}
          </td>
          <td class="py-4 px-6 text-sm {% if transaction.status == 'atrasado' %}text-red-600{% else %}text-gray-600{% endif %}">
            {{ transaction.account.nome }}
          </td>
          <td class="py-4 px-6 text-sm {% if transaction.status == 'atrasado' %}text-red-600{% else %}text-gray-600{% endif %}">
            {% if transaction.is_installment %}
              {{ transaction.installment_number }}/{{ transaction.installment_total }}
            {% else %}
              -
            {% endif %}
          </td>
          <td class="py-4 px-6 text-sm {% if transaction.status == 'atrasado' %}text-red-600{% else %}text-gray-600{% endif %}">
            {{ transaction.get_payment_origin_display|default:"-" }}
          </td>
          <td class="py-4 px-6 text-sm {% if transaction.status == 'atrasado' %}text-red-600{% else %}text-gray-600{% endif %}">
            {% if transaction.is_recurring %}
              Recorrente ({{ transaction.get_recurrence_period_display }})
            {% else %}
              Único
            {% endif %}
          </td>
          <td class="py-4 px-6 text-sm {% if transaction.status == 'atrasado' %}text-red-600{% else %}text-gray-700{% endif %}">
            R$ {{ transaction.valor|floatformat:2 }}
          </td>
          <td class="py-4 px-6">
            {% if transaction.status == 'previsto' %}
            <span class="px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-700">Previsto</span>
            {% if transaction.is_projection %}
            <span class="ml-2 px-2 py-0.5 rounded-full text-[10px] font-semibold bg-slate-100 text-slate-600">PREVISÃO</span>
            {% endif %}
            {% elif transaction.status == 'atrasado' %}
            <span class="px-3 py-1 rounded-full text-xs font-semibold bg-orange-100 text-orange-700">Atrasado</span>
            {% elif transaction.status == 'cancelado' %}
            <span class="px-3 py-1 rounded-full text-xs font-semibold bg-gray-200 text-gray-600">Cancelado</span>
            {% else %}
            <span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700">Realizado</span>
            {% endif %}
          </td>
          <td class="py-4 px-6">
            <div class="flex flex-wrap items-center justify-center gap-2">
              {% if transaction.status != 'realizado' and transaction.status != 'cancelado' and not transaction.is_projection %}
              <a
                href="{% url 'finance:transaction_mark_completed' transaction.id %}"
                class="px-3 py-2 bg-green-600 text-white rounded-lg text-xs font-semibold hover:bg-green-700 transition-colors"
                title="Marcar como realizado"
              >
                <i class="fas fa-check"></i>
              </a>
              {% elif transaction.status == 'realizado' %}
              <form method="post" action="{% url 'finance:transaction_mark_pending' transaction.id %}">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                <button
                  type="submit"
                  class="px-3 py-2 bg-gray-500 text-white rounded-lg text-xs font-semibold hover:bg-gray-600 transition-colors"
                  title="Voltar para previsto"
                >
                  <i class="fas fa-undo"></i>
                </button>
              </form>
              {% endif %}
              {% if transaction.is_installment and transaction.status != 'realizado' and transaction.status != 'cancelado' %}
              <form method="post" action="{% url 'finance:transaction_cancel' transaction.id %}">
                {% csrf_token %}
                <button
                  type="submit"
                  class="px-3 py-2 bg-gray-600 text-white rounded-lg text-xs font-semibold hover:bg-gray-700 transition-colors"
                  title="Cancelar parcela"
                >
                  <i class="fas fa-ban"></i>
                </button>
              </form>
              {% endif %}
              <a
                href="{% url 'finance:transaction_update' transaction.id %}"
                class="p-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors"
                title="Editar"
              >
                <i class="fas fa-edit text-sm"></i>
              </a>
              {% if not transaction.is_installment and transaction.status != 'realizado' or not transaction.is_installment and not transaction.data_pagamento %}
              <a
                href="{% url 'finance:transaction_delete' transaction.id %}"
                class="p-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
                title="Excluir"
              >
                <i class="fas fa-trash-alt text-sm"></i>
              </a>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="text-center py-12 text-gray-500">
    <i class="fas fa-receipt text-5xl mb-4"></i>
    <p class="text-lg font-semibold mb-2">Nenhum lancamento encontrado</p>
    <p class="text-sm">Crie seu primeiro lancamento financeiro.</p>
    <a
      href="{% url 'finance:transaction_create' %}"
      class="inline-block mt-4 px-6 py-3 bg-primary text-white rounded-lg font-semibold hover:bg-purple-700 transition-colors"
    >
      <i class="fas fa-plus mr-2"></i>Novo lançamento
    </a>
  </div>
  {% endif %}
</div>

{% if is_paginated %}
<div class="mt-6 flex flex-wrap justify-between items-center gap-4">
  <span class="text-sm text-gray-600">
    Pagina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
  </span>
  <div class="space-x-2">
    {% if page_obj.has_previous %}
    <a
      href="?page=1"
      class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 transition-colors"
    >
      <i class="fas fa-angle-double-left"></i>
    </a>
    <a
      href="?page={{ page_obj.previous_page_number }}"
      class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 transition-colors"
    >
      <i class="fas fa-angle-left"></i> Anterior
    </a>
    {% endif %}

    <span class="px-4 py-2 bg-primary text-white rounded">
      {{ page_obj.number }}
    </span>

    {% if page_obj.has_next %}
    <a
      href="?page={{ page_obj.next_page_number }}"
      class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 transition-colors"
    >
      Proxima <i class="fas fa-angle-right"></i>
    </a>
    <a
      href="?page={{ page_obj.paginator.num_pages }}"
      class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 transition-colors"
    >
      <i class="fas fa-angle-double-right"></i>
    </a>
    {% endif %}
  </div>
</div>
{% endif %}
{% endblock %}
